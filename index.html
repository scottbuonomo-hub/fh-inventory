<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>FH Liquor Inventory</title>
  <link rel="icon" href="favicon.ico">
  <style>
    :root{
      --bg:#0b0f19; --panel:#121a2a; --text:#e7ecff; --muted:#aab3d6;
      --border:rgba(255,255,255,.12); --accent:#6ea8ff; --good:#52d19a; --warn:#ffcc66; --bad:#ff6b6b;
      --shadow: 0 16px 40px rgba(0,0,0,.35);
      --radius:16px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:var(--sans);
      background:radial-gradient(1200px 700px at 10% 0%, rgba(110,168,255,.18), transparent 50%),
                 radial-gradient(900px 600px at 90% 20%, rgba(82,209,154,.12), transparent 55%),
                 var(--bg);
      color:var(--text);
    }
    .wrap{max-width:1200px; margin:28px auto; padding:0 18px 40px;}
    header{display:flex; gap:14px; align-items:flex-end; justify-content:space-between; margin-bottom:16px;}
    .title{display:flex; flex-direction:column; gap:6px;}
    h1{font-size:22px; margin:0; letter-spacing:.2px}
    .sub{color:var(--muted); font-size:13px}
    .pillbar{display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:flex-end}
    .pill{
      border:1px solid var(--border); background:rgba(255,255,255,.04);
      padding:8px 10px; border-radius:999px; font-size:12px; color:var(--muted);
      display:flex; gap:8px; align-items:center;
    }
    .pill b{color:var(--text); font-weight:600}
    .btn{
      appearance:none; border:1px solid var(--border); background:rgba(255,255,255,.06);
      color:var(--text); padding:10px 12px; border-radius:12px; cursor:pointer; font-weight:700;
      transition:transform .02s ease, background .15s ease, border-color .15s ease;
      display:inline-flex; gap:8px; align-items:center;
    }
    .btn:hover{background:rgba(255,255,255,.09); border-color:rgba(255,255,255,.18)}
    .btn:active{transform:translateY(1px)}
    .btn.primary{background:rgba(110,168,255,.18); border-color:rgba(110,168,255,.35)}
    .btn.primary:hover{background:rgba(110,168,255,.24)}
    .btn.danger{background:rgba(255,107,107,.12); border-color:rgba(255,107,107,.30)}
    .btn.ghost{background:transparent}
    .grid{display:grid; grid-template-columns: 280px 1fr; gap:14px;}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} }
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding:14px 14px 10px; border-bottom:1px solid var(--border);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      background:rgba(0,0,0,.14);
    }
    .card .hd h2{font-size:14px; margin:0; letter-spacing:.3px}
    .card .bd{padding:14px}
    .tabs{display:flex; gap:8px; flex-wrap:wrap}
    .tab{
      padding:10px 12px; border-radius:12px; border:1px solid var(--border);
      background:rgba(255,255,255,.04); color:var(--muted); cursor:pointer; font-weight:800; font-size:12px;
    }
    .tab.active{background:rgba(110,168,255,.18); border-color:rgba(110,168,255,.35); color:var(--text)}
    label{font-size:12px; color:var(--muted); display:block; margin-bottom:6px}
    .field{display:flex; flex-direction:column; gap:6px; min-width:180px}
    input, select{
      width:100%; padding:10px 11px; border-radius:12px; border:1px solid var(--border);
      background:rgba(0,0,0,.18); color:var(--text); outline:none;
    }
    input::placeholder{color:rgba(231,236,255,.35)}
    input:focus, select:focus{border-color:rgba(110,168,255,.55)}
    .hint{color:var(--muted); font-size:12px; line-height:1.35}
    .divider{height:1px; background:var(--border); margin:12px 0}
    .tablewrap{overflow:auto; border-radius:14px; border:1px solid var(--border)}
    table{width:100%; border-collapse:separate; border-spacing:0; min-width:860px; background:rgba(0,0,0,.18);}
    th, td{padding:10px 10px; border-bottom:1px solid rgba(255,255,255,.08); vertical-align:middle; font-size:13px;}
    th{position:sticky; top:0; background:rgba(18,26,42,.92); z-index:1; text-align:left; color:var(--muted); font-size:12px;}
    tr:hover td{background:rgba(255,255,255,.03)}
    .right{text-align:right}
    .mono{font-family:var(--mono)}
    .badge{
      padding:4px 8px; border-radius:999px; border:1px solid var(--border);
      font-size:11px; color:var(--muted); background:rgba(255,255,255,.04); display:inline-flex; gap:6px; align-items:center;
    }
    .badge.good{border-color:rgba(82,209,154,.35); background:rgba(82,209,154,.12); color:#bff6dc}
    .kpis{display:grid; grid-template-columns:repeat(4, 1fr); gap:10px}
    @media (max-width: 980px){ .kpis{grid-template-columns:repeat(2, 1fr)} }
    .kpi{padding:12px; border-radius:14px; border:1px solid var(--border); background:rgba(255,255,255,.03);}
    .kpi .t{font-size:12px; color:var(--muted); margin-bottom:6px}
    .kpi .v{font-size:16px; font-weight:900}
    .kpi .s{font-size:12px; color:var(--muted); margin-top:2px}
    .actions{display:flex; gap:8px; flex-wrap:wrap; align-items:center; justify-content:flex-end}
    .toast{
      position:fixed; right:14px; bottom:14px; padding:12px 12px;
      border-radius:14px; border:1px solid var(--border);
      background:rgba(18,26,42,.92); box-shadow:var(--shadow);
      color:var(--text); display:none; max-width:340px;
    }
    .toast.show{display:block}
    .toast .msg{font-size:13px; line-height:1.35}
    /* Sticky Actions column in Items table */
    th.sticky-r, td.sticky-r{
      position: sticky; right: 0;
      background: rgba(18,26,42,.96);
      box-shadow: -10px 0 14px rgba(0,0,0,.25);
      z-index: 2;
    }
    td.sticky-r{ background: rgba(0,0,0,.28); }
    /* Modal */
    .modal{ position:fixed; inset:0; background:rgba(0,0,0,.55); display:none; align-items:center; justify-content:center; z-index:9999; padding:18px; }
    .modalCard{ width:min(560px, 96vw); background:rgba(20,22,26,.98); border:1px solid rgba(255,255,255,.12); border-radius:18px; padding:16px 16px 14px; box-shadow:0 18px 60px rgba(0,0,0,.55); }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
<div class="wrap">
  <header>
    <div class="title">
      <h1>FH Liquor Inventory <span class="badge" id="appVersionBadge">â€”</span></h1>
      <div class="sub">Live (GitHub Pages) â€¢ Optional Cloud Sync (Supabase).</div>
    </div>
    <div class="pillbar">
      <div class="pill">
        Month: <b id="pillMonth">â€”</b>
        <span id="cloudStatus" class="badge" style="margin-left:10px; display:none;">Cloud</span>
        <button id="authBtn" class="btn" style="margin-left:8px; display:none;">Sign in</button>
      </div>
      <div class="pill">Items: <b id="pillItems">0</b></div>
      <button class="btn ghost" id="btnExportAll">Export CSV</button>
    </div>
  </header>

  <div class="grid">
    <div class="card">
      <div class="hd"><h2>Navigation</h2></div>
      <div class="bd">
        <div class="tabs">
          <button class="tab" data-tab="items">Items</button>
          <button class="tab active" data-tab="counts">Counts</button>
          <button class="tab" data-tab="reports">Reports</button>
        </div>

        <div class="divider"></div>

        <div class="field">
          <label for="monthSelect">Inventory Month</label>
          <select id="monthSelect"></select>
          <div class="hint">Pick the month youâ€™re counting. Counts are stored per month.</div>
        </div>

        <div class="divider"></div>

        <div class="hint">
          <b>Workflow:</b><br>
          1) Keep your master list clean in <b>Items</b><br>
          2) Once/month, enter counts in <b>Counts</b><br>
          3) Send Accounting the <b>Grand Total Value</b> from <b>Reports</b>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="hd">
        <h2 id="mainTitle">Counts</h2>
        <div class="actions" id="mainActions"></div>
      </div>
      <div class="bd" id="mainBody"></div>
    </div>
  </div>
</div>

<div class="toast" id="toast"><div class="msg" id="toastMsg"></div></div>

<!-- Cloud Sign-in Modal -->
<div id="authModal" class="modal">
  <div class="modalCard">
    <div style="display:flex; justify-content:space-between; align-items:center; gap:12px;">
      <h3 style="margin:0;">Sign in (Cloud Sync)</h3>
      <button id="authModalClose" class="btn">âœ•</button>
    </div>
    <p class="hint" style="margin:8px 0 12px;">
      Enter your email and youâ€™ll receive a magic link. Click it to sign in.
    </p>
    <div style="display:flex; gap:10px; align-items:flex-end; flex-wrap:wrap;">
      <div class="field" style="flex:1; min-width:260px;">
        <label>Email</label>
        <input id="authEmail" placeholder="name@columbia.edu" />
      </div>
      <button id="authSend" class="btn primary">Send Link</button>
    </div>
    <div class="divider"></div>
    <p class="hint" id="authMsg" style="margin:0;"></p>
  </div>
</div>

<script>
(() => {
  // =========================
  // Build + Version
  // =========================
  const APP_VERSION = "vPROD-2";
  const STORE_KEY = "fh_inv_live_v8_clean";
  document.getElementById("appVersionBadge").textContent = APP_VERSION;

  // =========================
  // Supabase config (your keys)
  // =========================
  const SUPABASE_URL = "https://yvznkaitcorhfoutfkmk.supabase.co";
  // Use the *anon public* key for supabase-js (JWT)
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl2em5rYWl0Y29yaGZvdXRma21rIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAyMjk0NTksImV4cCI6MjA4NTgwNTQ1OX0.MbCJiFh_O4WEfiEpVfeRo7FWF9rac-C-eJR4k8rgleE";
  // (Provided publishable key kept for reference, not used by supabase-js)
  const SUPABASE_PUBLISHABLE_KEY = "sb_publishable_sAebZGIDamLvoOHt-dPyFA_D7Z8iR30";
  const CLOUD_ROW_ID = 1; // single shared row
  const hasSupabaseConfig = () => /^https?:\/\//i.test(SUPABASE_URL) && (SUPABASE_ANON_KEY||"").length > 20;

  let sb = null;
  let cloudMode = false;

  // =========================
  // Helpers
  // =========================
  const $ = (sel, root=document) => root.querySelector(sel);
  const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
  const escapeHtml = (s)=>String(s??"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;");
  const fmtMoney = (n) => Number(n||0).toLocaleString(undefined,{style:"currency",currency:"USD"});
  const fmtNum = (n) => Number(n||0).toLocaleString(undefined,{maximumFractionDigits:2});
  const toast = (msg) => { $("#toastMsg").textContent = msg; $("#toast").classList.add("show"); clearTimeout(toast._t);
    toast._t=setTimeout(()=>$("#toast").classList.remove("show"),2200); };

  function isValidMonth(s){ return typeof s === "string" && /^\d{4}-\d{2}$/.test(s); }
  function yyyymmFromDate(d){ return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}`; }
  function addMonths(yyyymm, delta){
    if(!isValidMonth(yyyymm)) return yyyymmFromDate(new Date());
    const [y,m] = yyyymm.split("-").map(Number);
    const d = new Date(y, m-1, 1);
    d.setMonth(d.getMonth()+delta);
    return yyyymmFromDate(d);
  }
  function prevMonth(yyyymm){ return addMonths(yyyymm, -1); }

  // Categories
  const DEFAULT_CATEGORIES = [
    "White Wine","Red Wine","Sparkling Wine",
    "Beer",
    "Vodka","Whiskey","Tequila","Gin","Rum","Cordials/Other"
  ];
  const isSpiritType = (cat) => ["Vodka","Whiskey","Tequila","Gin","Rum","Cordials/Other"].includes(cat);

  const uuid = () => "i_" + Math.random().toString(16).slice(2) + Date.now().toString(16);

  // =========================
  // State
  // =========================
  function defaultState(){
    const now=new Date(); const thisMonth=yyyymmFromDate(now); const lastMonth=prevMonth(thisMonth);
    // Keep your same seed items (short list; your real list will load from localStorage)
    const items=[
      {id:uuid(),name:"CAVIT PG",category:"White Wine",unit_cost:6.11,uom:"btl",active:true},
      {id:uuid(),name:"KIM CRAWFORD SB large",category:"White Wine",unit_cost:13.50,uom:"btl",active:true},
      {id:uuid(),name:"KIM CRAWFORD SB small",category:"White Wine",unit_cost:13.50,uom:"btl",active:true},
      {id:uuid(),name:"KOSHER CHARD",category:"White Wine",unit_cost:10.21,uom:"btl",active:true},
      {id:uuid(),name:"LOUIS JADOT CHARD",category:"White Wine",unit_cost:13.09,uom:"btl",active:true},
      {id:uuid(),name:"MINUTY ROSE",category:"White Wine",unit_cost:16.24,uom:"btl",active:true},
      {id:uuid(),name:"ROB MONDAVI PRIV CHARD",category:"White Wine",unit_cost:18.66,uom:"btl",active:true},
      {id:uuid(),name:"ROBERT MONDAVI CHARD",category:"White Wine",unit_cost:14.72,uom:"btl",active:true},
      {id:uuid(),name:"STAGS LEAP CHARD",category:"White Wine",unit_cost:19.79,uom:"btl",active:true},
      {id:uuid(),name:"SYCAMORE LANE  Chard",category:"White Wine",unit_cost:6.46,uom:"btl",active:true},
      {id:uuid(),name:"SYCAMORE LANE PINOT GRIGIO",category:"White Wine",unit_cost:8.66,uom:"btl",active:true},
      {id:uuid(),name:"KOSHER CAB",category:"Red Wine",unit_cost:10.21,uom:"btl",active:true},
      {id:uuid(),name:"STAGS LEAP CAB",category:"Red Wine",unit_cost:23.22,uom:"btl",active:true},
      {id:uuid(),name:"SYCAMORE LANE CAB",category:"Red Wine",unit_cost:5.54,uom:"btl",active:true},
      {id:uuid(),name:"SYCAMORE LANE Merlot",category:"Red Wine",unit_cost:11.00,uom:"btl",active:true},
      {id:uuid(),name:"Two Vines PINOT NOIR",category:"Red Wine",unit_cost:14.09,uom:"btl",active:true},
      {id:uuid(),name:"BARON KOSHER CHAMPAGNE",category:"Sparkling Wine",unit_cost:12.66,uom:"btl",active:true},
      {id:uuid(),name:"Louis Pommery",category:"Sparkling Wine",unit_cost:0.00,uom:"btl",active:true},
      {id:uuid(),name:"VEUVE CLIQUOT",category:"Sparkling Wine",unit_cost:27.00,uom:"btl",active:true},
      {id:uuid(),name:"Yulupa PROSECCO",category:"Sparkling Wine",unit_cost:13.66,uom:"btl",active:true},
      {id:uuid(),name:"Abita Light",category:"Beer",unit_cost:1.29,uom:"cs",active:true},
      {id:uuid(),name:"AMSTEL",category:"Beer",unit_cost:1.33,uom:"cs",active:true},
      {id:uuid(),name:"Angry Orchard",category:"Beer",unit_cost:1.29,uom:"cs",active:true},
      {id:uuid(),name:"BLUE MOON",category:"Beer",unit_cost:1.65,uom:"cs",active:true},
      {id:uuid(),name:"BROOKLYN",category:"Beer",unit_cost:1.35,uom:"cs",active:true},
      {id:uuid(),name:"DOG FISH",category:"Beer",unit_cost:1.54,uom:"cs",active:true},
      {id:uuid(),name:"HEINEKEN",category:"Beer",unit_cost:1.33,uom:"cs",active:true},
      {id:uuid(),name:"Lagunitas",category:"Beer",unit_cost:1.35,uom:"cs",active:true},
      {id:uuid(),name:"MODELLO Negra",category:"Beer",unit_cost:1.35,uom:"cs",active:true},
      {id:uuid(),name:"Nice Slice",category:"Beer",unit_cost:1.54,uom:"cs",active:true},
      {id:uuid(),name:"ROUGE",category:"Beer",unit_cost:1.35,uom:"cs",active:true},
      {id:uuid(),name:"STELLA",category:"Beer",unit_cost:1.29,uom:"cs",active:true},
      {id:uuid(),name:"ABSOLUT",category:"Vodka",unit_cost:0.00,uom:"btl",active:true},
      {id:uuid(),name:"GREYGOOSE",category:"Vodka",unit_cost:38.29,uom:"btl",active:true},
      {id:uuid(),name:"KETTLE ONE - Grapefruit & Rose",category:"Vodka",unit_cost:31.77,uom:"btl",active:true},
      {id:uuid(),name:"KING ST. VODKA",category:"Vodka",unit_cost:31.77,uom:"btl",active:true},
      {id:uuid(),name:"STOLI RAZBERRY",category:"Vodka",unit_cost:26.89,uom:"btl",active:true},
      {id:uuid(),name:"STOLI VANILLA",category:"Vodka",unit_cost:26.89,uom:"btl",active:true},
      {id:uuid(),name:"BUSHMILLS",category:"Whiskey",unit_cost:22.19,uom:"btl",active:true},
      {id:uuid(),name:"CANADIAN CLUB",category:"Whiskey",unit_cost:22.69,uom:"btl",active:true},
      {id:uuid(),name:"CHIVAS",category:"Whiskey",unit_cost:35.00,uom:"btl",active:true},
      {id:uuid(),name:"CROWN ROYAL",category:"Whiskey",unit_cost:37.36,uom:"btl",active:true},
      {id:uuid(),name:"DEWARS",category:"Whiskey",unit_cost:23.75,uom:"btl",active:true},
      {id:uuid(),name:"GLENFIDICH",category:"Whiskey",unit_cost:49.35,uom:"btl",active:true},
      {id:uuid(),name:"GLENLIVET",category:"Whiskey",unit_cost:49.35,uom:"btl",active:true},
      {id:uuid(),name:"JACK DANIELS",category:"Whiskey",unit_cost:30.00,uom:"btl",active:true},
      {id:uuid(),name:"JAMESON",category:"Whiskey",unit_cost:35.07,uom:"btl",active:true},
      {id:uuid(),name:"JOHNNY BLACK",category:"Whiskey",unit_cost:45.36,uom:"btl",active:true},
      {id:uuid(),name:"JOHNNY RED",category:"Whiskey",unit_cost:22.18,uom:"btl",active:true},
      {id:uuid(),name:"KNOB CREEK",category:"Whiskey",unit_cost:35.00,uom:"btl",active:true},
      {id:uuid(),name:"MAKERS",category:"Whiskey",unit_cost:33.98,uom:"btl",active:true},
      {id:uuid(),name:"MC CALLAN 12YRS",category:"Whiskey",unit_cost:45.87,uom:"btl",active:true},
      {id:uuid(),name:"SEAGRAMS",category:"Whiskey",unit_cost:18.98,uom:"btl",active:true},
      {id:uuid(),name:"MEZCAL JOVEN",category:"Tequila",unit_cost:35.00,uom:"btl",active:true},
      {id:uuid(),name:"PATRON SILVER",category:"Tequila",unit_cost:40.01,uom:"btl",active:true},
      {id:uuid(),name:"BEEFEATER",category:"Gin",unit_cost:23.39,uom:"btl",active:true},
      {id:uuid(),name:"BOMBAY SAPPHIRE",category:"Gin",unit_cost:29.99,uom:"btl",active:true},
      {id:uuid(),name:"GORDON",category:"Gin",unit_cost:31.99,uom:"btl",active:true},
      {id:uuid(),name:"TANQUERY",category:"Gin",unit_cost:29.68,uom:"btl",active:true},
      {id:uuid(),name:"BAC ARDI LIMON",category:"Rum",unit_cost:18.99,uom:"btl",active:true},
      {id:uuid(),name:"BACARDI",category:"Rum",unit_cost:19.39,uom:"btl",active:true},
      {id:uuid(),name:"CAPTAIN MORGAN",category:"Rum",unit_cost:19.39,uom:"btl",active:true},
      {id:uuid(),name:"GOSELINGS",category:"Rum",unit_cost:19.86,uom:"btl",active:true},
      {id:uuid(),name:"MALIBU",category:"Rum",unit_cost:24.00,uom:"btl",active:true},
      {id:uuid(),name:"MYERS",category:"Rum",unit_cost:30.07,uom:"btl",active:true},
      {id:uuid(),name:"AMARETTO DISARONO",category:"Cordials/Other",unit_cost:32.00,uom:"btl",active:true},
      {id:uuid(),name:"BALIEYS",category:"Cordials/Other",unit_cost:31.89,uom:"btl",active:true},
      {id:uuid(),name:"BLUE CURACO",category:"Cordials/Other",unit_cost:11.01,uom:"btl",active:true},
      {id:uuid(),name:"CACHACA",category:"Cordials/Other",unit_cost:21.11,uom:"btl",active:true},
      {id:uuid(),name:"CAMPARI",category:"Cordials/Other",unit_cost:29.00,uom:"btl",active:true},
      {id:uuid(),name:"CHAMBORD",category:"Cordials/Other",unit_cost:29.99,uom:"btl",active:true},
      {id:uuid(),name:"COINTREAU",category:"Cordials/Other",unit_cost:45.27,uom:"btl",active:true},
      {id:uuid(),name:"DRAMBIUE",category:"Cordials/Other",unit_cost:39.49,uom:"btl",active:true},
      {id:uuid(),name:"FRANGELICO",category:"Cordials/Other",unit_cost:26.49,uom:"btl",active:true},
      {id:uuid(),name:"GINGER BEER",category:"Cordials/Other",unit_cost:0.00,uom:"btl",active:true},
      {id:uuid(),name:"GODIVA WHITE CHOCOLATE",category:"Cordials/Other",unit_cost:19.90,uom:"btl",active:true},
      {id:uuid(),name:"GODVIVA  MILK CHOCOLATE & DARK",category:"Cordials/Other",unit_cost:20.59,uom:"btl",active:true},
      {id:uuid(),name:"GRAND MARNIER",category:"Cordials/Other",unit_cost:42.28,uom:"btl",active:true},
      {id:uuid(),name:"HENNESSY VSOP",category:"Cordials/Other",unit_cost:45.00,uom:"btl",active:true},
      {id:uuid(),name:"KAHLUA",category:"Cordials/Other",unit_cost:26.04,uom:"btl",active:true},
      {id:uuid(),name:"KEDEM DRY",category:"Cordials/Other",unit_cost:36.46,uom:"btl",active:true},
      {id:uuid(),name:"KEDEM SWEET",category:"Cordials/Other",unit_cost:36.46,uom:"btl",active:true},
      {id:uuid(),name:"MARTINI & ROSSI DRY / Foro DRY",category:"Cordials/Other",unit_cost:9.69,uom:"btl",active:true},
      {id:uuid(),name:"MARTINI & ROSSI SWEET",category:"Cordials/Other",unit_cost:9.69,uom:"btl",active:true},
      {id:uuid(),name:"PEACH SNAPS",category:"Cordials/Other",unit_cost:9.00,uom:"btl",active:true},
      {id:uuid(),name:"PEPPERMINT SCHNAPPS",category:"Cordials/Other",unit_cost:9.00,uom:"btl",active:true},
      {id:uuid(),name:"PERNOD",category:"Cordials/Other",unit_cost:32.11,uom:"btl",active:true},
      {id:uuid(),name:"REMY MARTIN VSOP",category:"Cordials/Other",unit_cost:60.50,uom:"btl",active:true},
      {id:uuid(),name:"ROMANO SAMBUCA",category:"Cordials/Other",unit_cost:27.69,uom:"btl",active:true},
      {id:uuid(),name:"RUMPLEMINTS",category:"Cordials/Other",unit_cost:26.49,uom:"btl",active:true},
      {id:uuid(),name:"SANDYMAN PORT",category:"Cordials/Other",unit_cost:26.00,uom:"btl",active:true},
      {id:uuid(),name:"SOUR APPLE",category:"Cordials/Other",unit_cost:9.00,uom:"btl",active:true},
      {id:uuid(),name:"SOUTHREN COMFORT",category:"Cordials/Other",unit_cost:24.06,uom:"btl",active:true},
      {id:uuid(),name:"TRIPLE SEC",category:"Cordials/Other",unit_cost:4.24,uom:"btl",active:true},
    ];
    const counts={}; counts[lastMonth]={}; counts[thisMonth]={};
    return {version:2, items, counts, monthPrices:{}, finalizedMonths:{}, settings:{monthsToShow:12, categories: DEFAULT_CATEGORIES.slice(), lastCategory:null}};
  }

  function loadState(){
    try{
      const raw=localStorage.getItem(STORE_KEY);
      if(!raw) return defaultState();
      const s=JSON.parse(raw);
      if(!s||typeof s!=="object") return defaultState();
      if(s.version !== 2) return defaultState();
      if(!Array.isArray(s.items)) s.items=[];
      if(s.items.length===0) return defaultState();
      if(!s.counts||typeof s.counts!=="object") s.counts={};
      if(!s.monthPrices||typeof s.monthPrices!=="object") s.monthPrices={};
      if(!s.finalizedMonths||typeof s.finalizedMonths!=="object") s.finalizedMonths={};
      if(!s.settings) s.settings={monthsToShow:12, categories: DEFAULT_CATEGORIES.slice(), lastCategory:null};
      if(!Array.isArray(s.settings.categories) || s.settings.categories.length===0) s.settings.categories = DEFAULT_CATEGORIES.slice();
      DEFAULT_CATEGORIES.forEach(c=>{ if(!s.settings.categories.includes(c)) s.settings.categories.push(c); });
      return s;
    }catch(e){
      return defaultState();
    }
  }

  let state = loadState();

// BOOT RECOVERY: if items ever get wiped (e.g., bad cloud payload), restore default master list
if(!state || typeof state !== "object") state = defaultState();
if(!Array.isArray(state.items)) state.items = [];
if(state.items.length === 0){
  const def = defaultState();
  state.items = def.items;
  if(!state.counts || typeof state.counts !== "object") state.counts = {};
  toast("Master item list was empty â€” restored defaults.");
}
  let currentTab = "counts";
  let selectedMonth = null;
  let costsUnlocked = false;

  function saveState(){
    localStorage.setItem(STORE_KEY, JSON.stringify(state));
    $("#pillItems").textContent = String((state.items||[]).filter(i=>i.active!==false).length);
  }

  // =========================
  // Month price snapshot
  // =========================
  function ensureMonthPriceSnapshot(month){
    if(!month) return;
    if(!state.monthPrices) state.monthPrices = {};
    if(!state.monthPrices[month]){
      state.monthPrices[month] = {};
      (state.items||[]).forEach(it => { state.monthPrices[month][it.id] = Number(it.unit_cost||0); });
      saveState();
      if(cloudMode) cloudSaveState();
    }
  }
  function getUnitCostForMonth(it, month){
    ensureMonthPriceSnapshot(month);
    const snap = state.monthPrices?.[month]?.[it.id];
    return (snap === undefined || snap === null) ? Number(it.unit_cost||0) : Number(snap||0);
  }
  function setUnitCostForMonth(it, month, value){
    const itemId = (typeof it === "object") ? it.id : it;
    if(!itemId || !month) return;
    if(!state.monthPrices) state.monthPrices = {};
    if(!state.monthPrices[month]) state.monthPrices[month] = {};
    const vNum = (value === "" || value === null || typeof value === "undefined") ? null : Number(value);
    if(vNum === null || Number.isNaN(vNum)) delete state.monthPrices[month][itemId];
    else state.monthPrices[month][itemId] = vNum;
  }

  function isMonthFinalized(month){ return !!(state.finalizedMonths && state.finalizedMonths[month]); }

  function clearCountsForMonth(month){
    if(!month) return;
    if(isMonthFinalized(month)){ toast("Month is finalized (locked)."); return; }
    if(!confirm("Clear ALL counts for " + month + "?\n\nThis sets every item to 0 for this month.")) return;
    if(!state.counts) state.counts = {};
    state.counts[month] = {};
    (state.items||[]).forEach(it => { state.counts[month][it.id] = 0; });
    saveState();
    if(cloudMode) cloudSaveState();
    render();
    toast("Cleared counts for " + month);
  }

  // =========================
  // Cloud sync
  // =========================
  function syncCloudUI(){
    const statusEl = $("#cloudStatus");
    const authBtn = $("#authBtn");
    if(!statusEl || !authBtn) return;

    if(!hasSupabaseConfig()){
      statusEl.style.display="none";
      authBtn.style.display="none";
      return;
    }
    statusEl.style.display="inline-flex";
    authBtn.style.display="inline-flex";

    if(cloudMode){
      statusEl.classList.add("good");
      statusEl.textContent = "Cloud: signed in";
      authBtn.textContent = "Sign out";
    }else{
      statusEl.classList.remove("good");
      statusEl.textContent = "Cloud: not signed in";
      authBtn.textContent = "Sign in";
    }
  }

  function openAuthModal(){
    const m=$("#authModal");
    const closeBtn=$("#authModalClose");
    const sendBtn=$("#authSend");
    const emailEl=$("#authEmail");
    const msg=$("#authMsg");
    if(!m||!sendBtn||!emailEl) return;
    msg.textContent="";
    m.style.display="flex";
    emailEl.value="";
    setTimeout(()=>emailEl.focus(),50);

    const close=()=>{ m.style.display="none"; };
    closeBtn.onclick=close;
    m.onclick=(e)=>{ if(e.target===m) close(); };

    sendBtn.onclick=async ()=>{
      const email=(emailEl.value||"").trim();
      if(!email){ msg.textContent="Please enter an email."; return; }
      if(!/@columbia\.edu$/i.test(email)){ msg.textContent="Use your @columbia.edu email."; return; }
      if(!sb||!sb.auth){ msg.textContent="Cloud not ready yet."; return; }
      sendBtn.disabled=true;
      msg.textContent="Sendingâ€¦";
      try{
        const { error } = await sb.auth.signInWithOtp({
          email,
          options:{ emailRedirectTo: window.location.href.split("#")[0] + "#"}
        });
        msg.textContent = error ? ("Error: " + error.message) : "Check your inbox for the magic link.";
      }catch(err){
        msg.textContent="Error sending link.";
        console.error(err);
      }finally{
        sendBtn.disabled=false;
      }
    };
  }

  
async function cloudLoadIntoState(preferCloud=false){
  if(!sb) return;
  const localBefore = state;
  try{
    const { data, error } = await sb
      .from("inventory_state")
      .select("state_json")
      .eq("id", CLOUD_ROW_ID)
      .single();
    if(error) throw error;

    const cloudState = (data && data.state_json && typeof data.state_json === "object") ? data.state_json : null;
    if(!cloudState) return;

    // normalize
    if(!Array.isArray(cloudState.items)) cloudState.items = [];
    if(!cloudState.counts || typeof cloudState.counts !== "object") cloudState.counts = {};
    if(!cloudState.monthPrices || typeof cloudState.monthPrices !== "object") cloudState.monthPrices = {};
    if(!cloudState.finalizedMonths || typeof cloudState.finalizedMonths !== "object") cloudState.finalizedMonths = {};
    if(!cloudState.settings) cloudState.settings = {monthsToShow:12, categories: DEFAULT_CATEGORIES.slice(), lastCategory:null};

    const cloudHasItems = cloudState.items.length > 0;
    const localHasItems = (localBefore?.items||[]).length > 0;

    if(cloudHasItems || preferCloud){
      state = cloudState;
    }else if(localHasItems){
      console.warn("Cloud state has no items; keeping local state.");
      try{
        if(cloudMode && sb){
          const seeded = localStorage.getItem("fh_inv_cloud_seeded")==="1";
          if(!seeded){
            const ok = confirm("Cloud is empty. Upload your local inventory list to the cloud so everyone shares the same data?\n\n(Recommended: Yes)");
            localStorage.setItem("fh_inv_cloud_seeded","1");
            if(ok){ await cloudSaveState(); toast("Cloud seeded from local data"); }
          }
        }
      }catch(_e){}
      return;
    }else{
      state = cloudState; // will be repaired on boot if empty
    }
  }catch(e){
    console.warn("Cloud load failed; using local.", e);
    toast("Cloud load failed (using local)");
  }
}

  async function cloudSaveState(){
    if(!cloudMode || !sb) return;
    const payload = { id: CLOUD_ROW_ID, state_json: state };
    const { error } = await sb.from("inventory_state").upsert(payload, { onConflict:"id" });
    if(error) throw error;
  }

  async function initSupabase(){
    try{
      if(!hasSupabaseConfig() || !window.supabase || typeof window.supabase.createClient !== "function"){
        syncCloudUI();
        return;
      }
      sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
        auth: { persistSession:true, autoRefreshToken:true, detectSessionInUrl:true }
      });

      // Button behavior
      $("#authBtn").onclick = async ()=>{
        if(!hasSupabaseConfig()) return;
        if(cloudMode){
          await sb.auth.signOut();
          cloudMode=false;
          syncCloudUI();
          toast("Signed out");
        }else{
          openAuthModal();
        }
      };

      // Restore session
      const { data } = await sb.auth.getSession();
      cloudMode = !!(data && data.session);
      syncCloudUI();

      if(cloudMode){
        try{
          await cloudLoadIntoState();
          saveState();
        }catch(e){ console.warn("Cloud load failed", e); }
      }

      sb.auth.onAuthStateChange(async (_event, session)=>{
        cloudMode = !!session;
        syncCloudUI();
        if(cloudMode){
          try{ await cloudLoadIntoState(); saveState(); render(); }catch(e){ console.warn(e); }
        }
      });
    }catch(e){
      console.error("initSupabase failed", e);
      cloudMode=false;
      syncCloudUI();
    }
  }

  // =========================
  // UI building
  // =========================
  function mkBtn(text, cls="", onClick=()=>{}){
    const b=document.createElement("button");
    b.className="btn"+(cls?" "+cls:"");
    b.textContent=text;
    b.onclick=onClick;
    return b;
  }
  function setTitle(t){ $("#mainTitle").textContent=t; }
  function setActions(nodes){ const host=$("#mainActions"); host.innerHTML=""; nodes.forEach(n=>host.appendChild(n)); }

  function buildMonthOptions(){
    const sel=$("#monthSelect");
    sel.innerHTML="";
    const cur = yyyymmFromDate(new Date());

    const real = new Set();
    Object.keys(state.counts||{}).forEach(k=>{ if(isValidMonth(k)) real.add(k); });
    Object.keys(state.monthPrices||{}).forEach(k=>{ if(isValidMonth(k)) real.add(k); });
    [cur, addMonths(cur,1), addMonths(cur,2), addMonths(cur,3)].forEach(m=>real.add(m));

    if(selectedMonth && isValidMonth(selectedMonth)) real.add(selectedMonth);

    const months = Array.from(real).sort();
    months.forEach(m=>{
      const opt=document.createElement("option");
      opt.value=m; opt.textContent=m;
      sel.appendChild(opt);
    });

    if(!selectedMonth || !real.has(selectedMonth)) selectedMonth = cur;
    sel.value = selectedMonth;
    $("#pillMonth").textContent = selectedMonth;
  }

  function catOrderIndex(cat){
    const cats = (state?.settings?.categories || DEFAULT_CATEGORIES);
    const idx = cats.indexOf(cat);
    return idx === -1 ? 999 : idx;
  }

  // =========================
  // Screens
  // =========================
  function render(){
    $("#pillMonth").textContent = selectedMonth || "â€”";
    $("#pillItems").textContent = String((state.items||[]).filter(i=>i.active!==false).length);
    $$(".tab").forEach(t=>t.classList.toggle("active", t.dataset.tab===currentTab));

    if(currentTab==="items") renderItems();
    if(currentTab==="counts") renderCounts();
    if(currentTab==="reports") renderReports();
  }

  function renderItems(){
    setTitle("Items");
    setActions([mkBtn("âž• Add Item","primary",()=>openItemEditor())]);

    const body=$("#mainBody");
    body.innerHTML = `
      <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:space-between; align-items:flex-end;">
        <div class="field" style="min-width:260px; flex:1;">
          <label>Search</label>
          <input id="itemSearch" placeholder="Type to filter itemsâ€¦" />
        </div>
        <div class="field" style="min-width:220px;">
          <label>Show</label>
          <select id="itemFilter">
            <option value="active" selected>Active items</option>
            <option value="all">All items</option>
            <option value="inactive">Inactive only</option>
          </select>
        </div>
      </div>
      <div class="divider"></div>
      <div class="hint">Scroll left/right if needed â€” Actions stays pinned on the right.</div>
      <div class="divider"></div>
      <div class="tablewrap">
        <table>
          <thead>
            <tr>
              <th style="min-width:240px;">Item</th>
              <th style="min-width:140px;">Category</th>
              <th style="min-width:80px;">UOM</th>
              <th class="right" style="min-width:120px;">Unit Cost</th>
              <th style="min-width:120px;">Status</th>
              <th class="right sticky-r" style="min-width:210px;">Actions</th>
            </tr>
          </thead>
          <tbody id="itemsTbody"></tbody>
        </table>
      </div>
    `;

    const search=$("#itemSearch");
    const filter=$("#itemFilter");

    const rerender=()=>{
      const q=(search.value||"").trim().toLowerCase();
      const f=filter.value;
      const rows=(state.items||[]).slice()
        .sort((a,b)=>{ const d=catOrderIndex(a.category)-catOrderIndex(b.category); return d!==0?d:(a.name||"").localeCompare(b.name||""); })
        .filter(it=>{
          const active = it.active!==false;
          if(f==="active" && !active) return false;
          if(f==="inactive" && active) return false;
          if(!q) return true;
          return (it.name||"").toLowerCase().includes(q) || (it.category||"").toLowerCase().includes(q);
        });

      const tb=$("#itemsTbody"); tb.innerHTML="";
      if(rows.length===0){
        tb.innerHTML = `<tr><td colspan="6" style="color:rgba(255,255,255,.7);">No matching items.</td></tr>`;
        return;
      }
      rows.forEach(it=>{
        const tr=document.createElement("tr");
        tr.innerHTML = `
          <td><b>${escapeHtml(it.name||"")}</b></td>
          <td>${escapeHtml(it.category||"")}</td>
          <td class="mono">${escapeHtml(it.uom||"")}</td>
          <td class="right mono">${fmtMoney(it.unit_cost||0)}</td>
          <td>${(it.active!==false)?`<span class="badge good">Active</span>`:`<span class="badge">Inactive</span>`}</td>
          <td class="right sticky-r"></td>
        `;
        const td=tr.lastElementChild;

        const edit=mkBtn("Edit","",()=>openItemEditor(it));
        const toggle=mkBtn((it.active!==false)?"Deactivate":"Activate","",()=>{
          it.active = !(it.active!==false);
          saveState(); if(cloudMode) cloudSaveState();
          renderItems(); toast(it.active!==false ? "Item activated" : "Item deactivated");
        });
        const del=mkBtn("Delete","danger",()=>{
          if(!confirm(`Delete "${it.name}"?\n\nThis removes it completely (including stored counts).`)) return;
          Object.keys(state.counts||{}).forEach(m=>{ if(state.counts[m]) delete state.counts[m][it.id]; });
          state.items = (state.items||[]).filter(x=>x.id!==it.id);
          saveState(); if(cloudMode) cloudSaveState();
          renderItems(); toast("Item deleted");
        });

        const wrap=document.createElement("div");
        wrap.style.display="flex"; wrap.style.gap="8px"; wrap.style.justifyContent="flex-end"; wrap.style.flexWrap="wrap";
        wrap.append(edit,toggle,del);
        td.appendChild(wrap);

        tb.appendChild(tr);
      });
    };

    search.addEventListener("input", rerender);
    filter.addEventListener("change", rerender);
    rerender();
  }

  function openItemEditor(existing=null){
    const isEdit=!!existing;
    const it = existing ? {...existing} : {id:uuid(), name:"", category:(state.settings.lastCategory||"Beer"), unit_cost:0, uom:"btl", active:true};

    setActions([]);
    const body=$("#mainBody");
    body.innerHTML = `
      <div style="display:flex; gap:10px; flex-wrap:wrap;">
        <div class="field" style="min-width:320px; flex:1;">
          <label>Item Name</label>
          <input id="editName" placeholder="e.g., Tito's 1L" />
        </div>
        <div class="field" style="min-width:220px;">
          <label>Category</label>
          <select id="editCategory"></select>
          <div class="hint" style="margin-top:6px;"><b>Category controls where this item appears on the Counts screen.</b></div>
        </div>
        <div class="field" style="min-width:120px;">
          <label>UOM</label>
          <input id="editUom" placeholder="btl/cs/keg" />
        </div>
        <div class="field" style="min-width:160px;">
          <label>Unit Cost</label>
          <input id="editCost" type="number" step="0.01" min="0" />
        </div>
        <div class="field" style="min-width:160px;">
          <label>Status</label>
          <select id="editActive">
            <option value="true">Active</option>
            <option value="false">Inactive</option>
          </select>
        </div>
      </div>
      <div class="divider"></div>
      <div class="actions">
        <button class="btn" id="cancelEdit">Cancel</button>
        <button class="btn primary" id="saveEdit">${isEdit?"Save Changes":"Add Item"}</button>
      </div>
    `;

    const catSel=$("#editCategory");
    const cats=(state.settings.categories||DEFAULT_CATEGORIES).slice().sort((a,b)=>a.localeCompare(b));
    cats.forEach(c=>{ const opt=document.createElement("option"); opt.value=c; opt.textContent=c; catSel.appendChild(opt); });
    const addOpt=document.createElement("option"); addOpt.value="__ADD__"; addOpt.textContent="âž• Add new categoryâ€¦"; catSel.appendChild(addOpt);

    $("#editName").value = it.name||"";
    $("#editCategory").value = it.category || (state.settings.lastCategory || cats[0] || "Beer");
    $("#editUom").value = it.uom||"";
    $("#editCost").value = Number(it.unit_cost||0);
    $("#editActive").value = String(it.active!==false);

    $("#editCategory").onchange = ()=>{
      if($("#editCategory").value==="__ADD__"){
        const name = prompt("New category name (e.g., White Wine, Vodka, Gin):");
        if(!name){ $("#editCategory").value = it.category || (state.settings.lastCategory || cats[0] || "Beer"); return; }
        const clean = name.trim();
        if(!clean){ $("#editCategory").value = it.category || (state.settings.lastCategory || cats[0] || "Beer"); return; }
        if(!state.settings.categories.includes(clean)) state.settings.categories.push(clean);
        saveState(); if(cloudMode) cloudSaveState();
        openItemEditor(existing);
      }
    };

    $("#cancelEdit").onclick = ()=>renderItems();
    $("#saveEdit").onclick = ()=>{
      const name=($("#editName").value||"").trim();
      if(!name){ toast("Item name is required"); return; }
      it.name=name;
      it.category = ($("#editCategory").value==="__ADD__") ? (it.category||"Beer") : $("#editCategory").value;
      state.settings.lastCategory = it.category;
      it.uom = ($("#editUom").value||"").trim();
      it.unit_cost = Number($("#editCost").value||0);
      it.active = $("#editActive").value==="true";

      if(isEdit){
        const idx=(state.items||[]).findIndex(x=>x.id===existing.id);
        if(idx>=0) state.items[idx]=it;
        toast("Item updated");
      }else{
        state.items.push(it);
        toast("Item added");
      }
      saveState(); if(cloudMode) cloudSaveState();
      renderItems();
    };
  }

  function computeTotalsForMonth(month){
    const byCategory={}; let grandTotal=0;
    const items=(state.items||[]).filter(i=>i.active!==false);
    const counts=(state.counts?.[month]||{});
    for(const it of items){
      const c=Number(counts[it.id]??0);
      const uc=getUnitCostForMonth(it, month);
      const v=c*uc;
      const cat=it.category||"Other";
      byCategory[cat]=(byCategory[cat]||0)+v;
      grandTotal+=v;
    }
    return {byCategory, grandTotal};
  }

  function copyPreviousMonthCounts(){
    const month = selectedMonth;
    if(!month){ toast("Pick a month first"); return; }
    const pmonth = prevMonth(month);
    if(!confirm(`Copy counts from ${pmonth} into ${month}?\n\nThis overwrites this monthâ€™s counts (you can still edit after).`)) return;

    if(!state.counts) state.counts = {};
    if(!state.counts[month]) state.counts[month] = {};
    if(!state.counts[pmonth]) state.counts[pmonth] = {};

    const activeItems = (state.items||[]).filter(i=>i.active!==false);
    ensureMonthPriceSnapshot(month);

    activeItems.forEach(it=>{
      const prev = Number(state.counts[pmonth][it.id] ?? 0);
      const cat = it.category || "Uncategorized";
      state.counts[month][it.id] = isSpiritType(cat) ? prev : Math.round(prev);
    });

    saveState(); if(cloudMode) cloudSaveState();
    toast("Previous month copied");
    currentTab="counts";
    render();
  }

  function renderCounts(){
    setTitle("Counts");
    const month = selectedMonth;
    const body = $("#mainBody");
    if(!month){ body.innerHTML = `<div class="hint">Pick a month.</div>`; setActions([]); return; }

    const pmonth = prevMonth(month);
    if(!state.counts) state.counts = {};
    if(!state.counts[month]) state.counts[month] = {};
    if(!state.counts[pmonth]) state.counts[pmonth] = {};

    // Actions
    const btnFinalize = isMonthFinalized(month)
      ? mkBtn("ðŸ”“ Unlock Month","",()=>{ if(!confirm(`Unlock ${month}?`)) return; delete state.finalizedMonths[month]; saveState(); if(cloudMode) cloudSaveState(); render(); toast("Month unlocked"); })
      : mkBtn("âœ… Finalize Month","",()=>{ if(!confirm(`Finalize ${month}?`)) return; state.finalizedMonths[month]=true; saveState(); if(cloudMode) cloudSaveState(); render(); toast("Month finalized"); });

    const btnCopyPrev = mkBtn("â†©ï¸Ž Copy Prev Month","",()=>copyPreviousMonthCounts());
    const btnClear = mkBtn("ðŸ§¹ Clear Counts","danger",()=>clearCountsForMonth(month));
    const btnCosts = mkBtn(costsUnlocked ? "ðŸ”’ Lock Costs" : "âœï¸ Edit Costs","",()=>{
      if(!costsUnlocked){
        if(!confirm("Unlock unit cost editing?\n\nThis is usually manager-only.")) return;
        costsUnlocked = true;
      }else{
        costsUnlocked = false;
      }
      render();
    });

    const btnSave = mkBtn("ðŸ’¾ Save Counts","primary",()=>{ saveState(); if(cloudMode) cloudSaveState(); toast("Saved"); });

    setActions([btnFinalize, btnCopyPrev, btnClear, btnCosts, btnSave]);

    // Items ordered category -> alpha
    const items=(state.items||[]).filter(i=>i.active!==false).slice().sort((a,b)=>{
      const d=catOrderIndex(a.category)-catOrderIndex(b.category);
      return d!==0?d:(a.name||"").localeCompare(b.name||"");
    });

    body.innerHTML = `
      <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:space-between; align-items:flex-end;">
        <div class="field" style="min-width:260px; flex:1;">
          <label>Search (optional)</label>
          <input id="countSearch" placeholder="Type to filter itemsâ€¦" />
          <div class="hint">Keyboard: <b>Enter</b> next, <b>Shift+Enter</b> previous, <b>â†‘/â†“</b> move.</div>
        </div>
        <div class="field" style="min-width:220px;">
          <label>Month</label>
          <div class="pill" style="justify-content:space-between;">
            <span class="mono">${month}</span>
            <span style="color:var(--muted);">Prev: <span class="mono">${pmonth}</span></span>
          </div>
        </div>
      </div>

      <div class="divider"></div>
      <div class="kpis" id="countsKpis"></div>
      <div class="divider"></div>
      <div id="countsGroups"></div>
    `;

    const search=$("#countSearch");
    const groupsHost=$("#countsGroups");

    function getFilteredItems(){
      const q=(search.value||"").trim().toLowerCase();
      if(!q) return items;
      return items.filter(it => (it.name||"").toLowerCase().includes(q) || (it.category||"").toLowerCase().includes(q));
    }

    function computeKpis(list){
      const countsCur = state.counts[month]||{};
      const countsPrev = state.counts[pmonth]||{};
      const totalsByCat = {};
      const prevByCat = {};
      let totalCur=0, totalPrev=0;

      list.forEach(it=>{
        const cat = it.category || "Uncategorized";
        const prev = Number(countsPrev[it.id] ?? 0);
        const cur  = Number(countsCur[it.id] ?? 0);
        const uc   = getUnitCostForMonth(it, month);
        const prevVal = prev*uc;
        const curVal  = cur*uc;

        totalsByCat[cat] = (totalsByCat[cat]||0) + curVal;
        prevByCat[cat]   = (prevByCat[cat]||0) + prevVal;
        totalCur += curVal; totalPrev += prevVal;
      });

      const wineCur = (totalsByCat["White Wine"]||0)+(totalsByCat["Red Wine"]||0)+(totalsByCat["Sparkling Wine"]||0);
      const winePrev = (prevByCat["White Wine"]||0)+(prevByCat["Red Wine"]||0)+(prevByCat["Sparkling Wine"]||0);
      const beerCur = (totalsByCat["Beer"]||0);
      const beerPrev = (prevByCat["Beer"]||0);
      const spiritsCur = (totalsByCat["Vodka"]||0)+(totalsByCat["Whiskey"]||0)+(totalsByCat["Tequila"]||0)+(totalsByCat["Gin"]||0)+(totalsByCat["Rum"]||0)+(totalsByCat["Cordials/Other"]||0);
      const spiritsPrev = (prevByCat["Vodka"]||0)+(prevByCat["Whiskey"]||0)+(prevByCat["Tequila"]||0)+(prevByCat["Gin"]||0)+(prevByCat["Rum"]||0)+(prevByCat["Cordials/Other"]||0);
      return {totalCur,totalPrev,wineCur,winePrev,beerCur,beerPrev,spiritsCur,spiritsPrev};
    }

    function renderKpis(list){
      const t = computeKpis(list);
      $("#countsKpis").innerHTML = `
        <div class="kpi"><div class="t">Grand Total Value</div><div class="v">${fmtMoney(t.totalCur)}</div><div class="s">Prev: ${fmtMoney(t.totalPrev)} | Î” ${fmtMoney(t.totalCur - t.totalPrev)}</div></div>
        <div class="kpi"><div class="t">Wine Total</div><div class="v">${fmtMoney(t.wineCur)}</div><div class="s">Prev: ${fmtMoney(t.winePrev)} | Î” ${fmtMoney(t.wineCur - t.winePrev)}</div></div>
        <div class="kpi"><div class="t">Beer Total</div><div class="v">${fmtMoney(t.beerCur)}</div><div class="s">Prev: ${fmtMoney(t.beerPrev)} | Î” ${fmtMoney(t.beerCur - t.beerPrev)}</div></div>
        <div class="kpi"><div class="t">Spirits Total</div><div class="v">${fmtMoney(t.spiritsCur)}</div><div class="s">Prev: ${fmtMoney(t.spiritsPrev)} | Î” ${fmtMoney(t.spiritsCur - t.spiritsPrev)}</div></div>
      `;
    }

    function makeRow(it){
      const cat = it.category || "Uncategorized";
      const prev = Number((state.counts[pmonth]||{})[it.id] ?? 0);
      const cur  = Number((state.counts[month]||{})[it.id] ?? 0);
      const variance = cur - prev;

      const row = document.createElement("div");
      row.style.display="grid";
      row.style.gridTemplateColumns="1.6fr 110px 140px 110px 120px 140px";
      row.style.gap="10px";
      row.style.alignItems="center";
      row.style.padding="10px 8px";
      row.style.borderBottom="1px solid rgba(255,255,255,.08)";
      row.innerHTML = `
        <div style="min-width:0;">
          <div style="font-weight:900; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${escapeHtml(it.name||"")}</div>
          <div class="hint" style="margin-top:2px;">${escapeHtml(cat)} â€¢ <span class="mono">${escapeHtml(it.uom||"")}</span></div>
        </div>
        <div class="right mono" data-prev>${fmtNum(prev)}</div>
        <div class="right" data-inputcell></div>
        <div class="right mono" data-var>${variance===0?"0":(variance>0?("+"+fmtNum(variance)):fmtNum(variance))}</div>
        <div class="right" data-costcell></div>
        <div class="right mono" data-line>${fmtMoney(cur*getUnitCostForMonth(it, month))}</div>
      `;

      const inputCell=row.querySelector("[data-inputcell]");
      const inp=document.createElement("input");
      inp.type="number";
      inp.inputMode="decimal";
      inp.value=String(cur);
      inp.dataset.itemid = it.id;

      if(isSpiritType(cat)){ inp.step="0.01"; inp.placeholder="0.00"; }
      else{ inp.step="1"; inp.placeholder="0"; }

      inp.style.textAlign="right";
      inp.style.fontWeight="900";
      inp.style.fontSize="14px";
      inp.style.padding="10px 10px";

      if(isMonthFinalized(month)){ inp.disabled=true; inp.style.opacity="0.6"; }

      function normalize(finalize=false){
        const v=Number(inp.value||0);
        if(!isSpiritType(cat)){
          if(!Number.isInteger(v)){
            inp.style.borderColor = "rgba(255,204,102,.65)";
            if(finalize){
              const rounded=Math.round(v);
              inp.value=String(rounded);
              state.counts[month][it.id]=rounded;
              toast("Wine/Beer must be whole bottles â€” rounded.");
            }
          }else{
            inp.style.borderColor="";
          }
        }else{
          inp.style.borderColor="";
        }
      }

      inp.addEventListener("input", ()=>{
        const v=Number(inp.value||0);
        state.counts[month][it.id]=v;

        const prevNow=Number((state.counts[pmonth]||{})[it.id] ?? 0);
        const varNow=v-prevNow;
        row.querySelector("[data-var]").textContent = varNow===0?"0":(varNow>0?("+"+fmtNum(varNow)):fmtNum(varNow));
        row.querySelector("[data-line]").textContent = fmtMoney(v*getUnitCostForMonth(it, month));

        normalize(false);
        renderKpis(getFilteredItems());
      });
      inp.addEventListener("blur", ()=>normalize(true));

      inp.addEventListener("keydown", (e)=>{
        const key=e.key;
        if(key==="Enter" || key==="ArrowDown" || key==="ArrowUp"){
          e.preventDefault();
          const inputs=Array.from(document.querySelectorAll('input[data-itemid]'));
          const idx=inputs.indexOf(inp);
          if(idx===-1) return;
          let nextIdx=idx;
          if(key==="ArrowDown" || (key==="Enter" && !e.shiftKey)) nextIdx=Math.min(inputs.length-1, idx+1);
          if(key==="ArrowUp" || (key==="Enter" && e.shiftKey)) nextIdx=Math.max(0, idx-1);
          inputs[nextIdx].focus();
          inputs[nextIdx].select();
        }
      });

      inputCell.appendChild(inp);

      // Cost cell (locked by default)
      const costCell=row.querySelector("[data-costcell]");
      const costInp=document.createElement("input");
      costInp.type="number";
      costInp.step="0.01";
      costInp.min="0";
      costInp.value = String(getUnitCostForMonth(it, month));
      costInp.style.textAlign="right";
      costInp.style.padding="8px 10px";
      costInp.style.fontSize="12px";
      costInp.style.fontWeight="800";
      costInp.disabled = !costsUnlocked;
      costInp.style.opacity = costsUnlocked ? "1" : "0.55";
      costInp.title = costsUnlocked ? "Edit unit cost for this month" : "Locked (manager-only). Click 'Edit Costs'.";

      costInp.addEventListener("input", ()=>{
        const v=Number(costInp.value||0);
        setUnitCostForMonth(it, month, v);
        const curNow=Number(state.counts[month][it.id] ?? 0);
        row.querySelector("[data-line]").textContent = fmtMoney(curNow*v);
        renderKpis(getFilteredItems());
      });

      costCell.appendChild(costInp);
      return row;
    }

    function renderGroups(){
      const list=getFilteredItems();
      renderKpis(list);

      const groups={};
      list.forEach(it=>{
        const cat=it.category||"Uncategorized";
        if(!groups[cat]) groups[cat]=[];
        groups[cat].push(it);
      });

      const cats=(state.settings.categories||DEFAULT_CATEGORIES).filter(c=>groups[c] && groups[c].length>0);

      groupsHost.innerHTML="";
      cats.forEach(cat=>{
        const card=document.createElement("div");
        card.className="card";
        card.style.marginBottom="12px";
        card.innerHTML = `
          <div class="hd"><h2>${escapeHtml(cat)}</h2></div>
          <div class="bd" style="padding:0;">
            <div style="display:grid; grid-template-columns:1.6fr 110px 140px 110px 120px 140px; gap:10px; padding:10px 8px; border-bottom:1px solid rgba(255,255,255,.10); color:var(--muted); font-size:12px;">
              <div>Item</div><div class="right">Prev</div><div class="right">This Month</div><div class="right">Var</div><div class="right">Unit Cost</div><div class="right">Line Value</div>
            </div>
            <div data-rows></div>
          </div>
        `;
        const rowsHost=card.querySelector("[data-rows]");
        groups[cat].slice().sort((a,b)=>(a.name||"").localeCompare(b.name||"")).forEach(it=>rowsHost.appendChild(makeRow(it)));
        groupsHost.appendChild(card);
      });

      if(!renderGroups._didFocusOnce){
        const active=document.activeElement;
        const typingInSearch=active && active.id==="countSearch";
        if(!typingInSearch){
          const first=groupsHost.querySelector('input[data-itemid]');
          if(first){ first.focus(); first.select(); renderGroups._didFocusOnce=true; }
        }
      }
    }

    search.addEventListener("input", ()=>renderGroups());
    renderGroups();
  }

  function renderReports(){
    setTitle("Reports");
    setActions([]);

    const totals=computeTotalsForMonth(selectedMonth);
    const wineTotal=(totals.byCategory["White Wine"]||0)+(totals.byCategory["Red Wine"]||0)+(totals.byCategory["Sparkling Wine"]||0);
    const beerTotal=(totals.byCategory["Beer"]||0);
    const spiritsTotal=(totals.byCategory["Vodka"]||0)+(totals.byCategory["Whiskey"]||0)+(totals.byCategory["Tequila"]||0)+(totals.byCategory["Gin"]||0)+(totals.byCategory["Rum"]||0)+(totals.byCategory["Cordials/Other"]||0);

    const body=$("#mainBody");
    const catRows=Object.keys(totals.byCategory||{}).sort().map(cat=>({cat,val:totals.byCategory[cat]}));
    body.innerHTML = `
      <div class="kpis">
        <div class="kpi"><div class="t">Month</div><div class="v mono">${selectedMonth||"â€”"}</div><div class="s">Ending value</div></div>
        <div class="kpi"><div class="t">Grand Total Inventory Value</div><div class="v">${fmtMoney(totals.grandTotal||0)}</div><div class="s">Send this to Accounting</div></div>
        <div class="kpi"><div class="t">Wine Total</div><div class="v">${fmtMoney(wineTotal)}</div><div class="s">White + Red + Sparkling</div></div>
        <div class="kpi"><div class="t">Beer Total</div><div class="v">${fmtMoney(beerTotal)}</div><div class="s">All beer</div></div>
      </div>

      <div class="kpis" style="margin-top:10px;">
        <div class="kpi"><div class="t">Spirits Total</div><div class="v">${fmtMoney(spiritsTotal)}</div><div class="s">All spirits (bundled)</div></div>
        <div class="kpi"><div class="t">White Wine</div><div class="v">${fmtMoney(totals.byCategory["White Wine"]||0)}</div><div class="s">Subtotal</div></div>
        <div class="kpi"><div class="t">Red Wine</div><div class="v">${fmtMoney(totals.byCategory["Red Wine"]||0)}</div><div class="s">Subtotal</div></div>
        <div class="kpi"><div class="t">Sparkling Wine</div><div class="v">${fmtMoney(totals.byCategory["Sparkling Wine"]||0)}</div><div class="s">Subtotal</div></div>
      </div>

      <div class="divider"></div>

      <div class="tablewrap">
        <table style="min-width:560px;">
          <thead><tr><th>Category</th><th class="right">Value</th></tr></thead>
          <tbody>
            ${catRows.map(r=>`<tr><td><b>${escapeHtml(r.cat)}</b></td><td class="right mono">${fmtMoney(r.val)}</td></tr>`).join("")}
            <tr><td><b>Total</b></td><td class="right mono"><b>${fmtMoney(totals.grandTotal||0)}</b></td></tr>
          </tbody>
        </table>
      </div>
    `;
  }

  // =========================
  // Export CSV
  // =========================
  $("#btnExportAll").onclick = ()=>{
    const m = selectedMonth;
    const t = computeTotalsForMonth(m);
    const rows = [["month","category","value"]];
    Object.keys(t.byCategory||{}).sort().forEach(cat => rows.push([m, cat, Math.round((t.byCategory[cat]||0)*100)/100]));
    rows.push([m, "TOTAL", Math.round((t.grandTotal||0)*100)/100]);
    const csv = rows.map(r => r.map(c => {
      const s = String(c ?? "");
      return /[",\n]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s;
    }).join(",")).join("\n");
    const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = `fh_inventory_value_${m}.csv`;
    document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);
    toast("CSV downloaded");
  };

  // Tabs
  $$(".tab").forEach(t=>t.addEventListener("click",()=>{ currentTab=t.dataset.tab; render(); }));

  // Month select
  $("#monthSelect").addEventListener("change",(e)=>{
    selectedMonth = e.target.value;
    ensureMonthPriceSnapshot(selectedMonth);
    saveState();
    if(cloudMode) cloudSaveState();
    render();
  });

  // Boot
  function boot(){
    buildMonthOptions();
    ensureMonthPriceSnapshot(selectedMonth);
    saveState();
    syncCloudUI();
    render();
  }

  boot();
  initSupabase(); // async, but won't block UI
})();
</script>
</body>
</html>