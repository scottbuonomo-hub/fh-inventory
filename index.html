<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>FH Liquor Inventory</title>
  <link rel="icon" href="favicon.ico">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root{
      --bg:#0b0f19; --text:#e7ecff; --muted:#aab3d6;
      --border:rgba(255,255,255,.12); --shadow: 0 16px 40px rgba(0,0,0,.35);
      --radius:16px; --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:var(--sans);
      background:
        radial-gradient(1200px 700px at 10% 0%, rgba(110,168,255,.18), transparent 50%),
        radial-gradient(900px 600px at 90% 20%, rgba(82,209,154,.12), transparent 55%),
        var(--bg);
      color:var(--text);
    }
    .wrap{max-width:1200px; margin:28px auto; padding:0 18px 40px;}
    header{display:flex; gap:14px; align-items:flex-end; justify-content:space-between; margin-bottom:16px;}
    .title{display:flex; flex-direction:column; gap:6px;}
    h1{font-size:22px; margin:0; letter-spacing:.2px}
    .sub{color:var(--muted); font-size:13px}
    .pillbar{display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:flex-end}
    .pill{
      border:1px solid var(--border); background:rgba(255,255,255,.04);
      padding:8px 10px; border-radius:999px; font-size:12px; color:var(--muted);
      display:flex; gap:8px; align-items:center;
    }
    .pill b{color:var(--text); font-weight:600}
    .btn{
      appearance:none; border:1px solid var(--border); background:rgba(255,255,255,.06);
      color:var(--text); padding:10px 12px; border-radius:12px; cursor:pointer; font-weight:600;
      transition:transform .02s ease, background .15s ease, border-color .15s ease;
      display:inline-flex; gap:8px; align-items:center;
    }
    .btn:hover{background:rgba(255,255,255,.09); border-color:rgba(255,255,255,.18)}
    .btn:active{transform:translateY(1px)}
    .btn.primary{background:rgba(110,168,255,.18); border-color:rgba(110,168,255,.35)}
    .btn.primary:hover{background:rgba(110,168,255,.24)}
    .btn.danger{background:rgba(255,107,107,.12); border-color:rgba(255,107,107,.30)}
    .btn.ghost{background:transparent}
    .grid{display:grid; grid-template-columns: 280px 1fr; gap:14px;}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} }
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding:14px 14px 10px; border-bottom:1px solid var(--border);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      background:rgba(0,0,0,.14);
    }
    .card .hd h2{font-size:14px; margin:0; letter-spacing:.3px}
    .card .bd{padding:14px}
    .tabs{display:flex; gap:8px; flex-wrap:wrap}
    .tab{
      padding:10px 12px; border-radius:12px; border:1px solid var(--border);
      background:rgba(255,255,255,.04); color:var(--muted); cursor:pointer; font-weight:700; font-size:12px;
    }
    .tab.active{background:rgba(110,168,255,.18); border-color:rgba(110,168,255,.35); color:var(--text)}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    label{font-size:12px; color:var(--muted); display:block; margin-bottom:6px}
    .field{display:flex; flex-direction:column; gap:6px; min-width:180px}
    input, select{
      width:100%; padding:10px 11px; border-radius:12px; border:1px solid var(--border);
      background:rgba(0,0,0,.18); color:var(--text); outline:none;
    }
    input::placeholder{color:rgba(231,236,255,.35)}
    input:focus, select:focus{border-color:rgba(110,168,255,.55)}
    .hint{color:var(--muted); font-size:12px; line-height:1.35}
    .divider{height:1px; background:var(--border); margin:12px 0}
    .tablewrap{overflow:auto; border-radius:14px; border:1px solid var(--border)}
    table{width:100%; border-collapse:separate; border-spacing:0; min-width:880px; background:rgba(0,0,0,.18);}
    th, td{padding:10px 10px; border-bottom:1px solid rgba(255,255,255,.08); vertical-align:middle; font-size:13px;}
    th{position:sticky; top:0; background:rgba(18,26,42,.92); z-index:1; text-align:left; color:var(--muted); font-size:12px; letter-spacing:.25px;}
    tr:hover td{background:rgba(255,255,255,.03)}
    .right{text-align:right}
    .mono{font-family:var(--mono)}
    .badge{
      padding:4px 8px; border-radius:999px; border:1px solid var(--border);
      font-size:11px; color:var(--muted); background:rgba(255,255,255,.04); display:inline-flex; gap:6px; align-items:center;
    }
    .badge.good{border-color:rgba(82,209,154,.35); background:rgba(82,209,154,.12); color:#bff6dc}
    .badge.bad{border-color:rgba(255,107,107,.35); background:rgba(255,107,107,.12); color:#ffd0d0}
    .kpis{display:grid; grid-template-columns:repeat(4, 1fr); gap:10px}
    @media (max-width: 980px){ .kpis{grid-template-columns:repeat(2, 1fr)} }
    .kpi{padding:12px; border-radius:14px; border:1px solid var(--border); background:rgba(255,255,255,.03);}
    .kpi .t{font-size:12px; color:var(--muted); margin-bottom:6px}
    .kpi .v{font-size:16px; font-weight:800}
    .kpi .s{font-size:12px; color:var(--muted); margin-top:2px}
    .actions{display:flex; gap:8px; flex-wrap:wrap; align-items:center; justify-content:flex-end}
    .toast{
      position:fixed; right:14px; bottom:14px; padding:12px 12px;
      border-radius:14px; border:1px solid var(--border);
      background:rgba(18,26,42,.92); box-shadow:var(--shadow);
      color:var(--text); display:none; max-width:340px;
    }
    .toast.show{display:block}
    .toast .msg{font-size:13px; line-height:1.35}
    /* Keep right-most Actions column visible */
    th.sticky-r, td.sticky-r{
      position: sticky; right: 0; background: rgba(18,26,42,.96);
      box-shadow: -10px 0 14px rgba(0,0,0,.25); z-index: 2;
    }
    td.sticky-r{ background: rgba(0,0,0,.28); }
    /* modal */
    .modal{ position:fixed; inset:0; background:rgba(0,0,0,.55); display:flex; align-items:center; justify-content:center; z-index:9999; padding:18px; }
    .modalCard{ width:min(560px, 96vw); background:rgba(20,22,26,.98); border:1px solid rgba(255,255,255,.12); border-radius:18px; padding:16px 16px 14px; box-shadow:0 18px 60px rgba(0,0,0,.55); }
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="title">
      <h1>FH Liquor Inventory <span class="badge" id="appVersionBadge">vâ€”</span></h1>
      <div class="sub">Live (GitHub Pages) â€¢ Optional Cloud Sync (Supabase).</div>
    </div>
    <div class="pillbar">
      <div class="pill">
        Month: <b id="pillMonth">â€”</b>
        <span id="cloudStatus" class="badge" style="margin-left:10px; display:none;">Cloud</span>
        <button id="authBtn" class="btn" style="margin-left:8px; display:none;">Sign in</button>
      </div>
      <div class="pill">Items: <b id="pillItems">0</b></div>
      <button class="btn ghost" id="btnExportAll">Export CSV</button>
    </div>
  </header>

  <div class="grid">
    <div class="card">
      <div class="hd"><h2>Navigation</h2></div>
      <div class="bd">
        <div class="tabs">
          <button class="tab" data-tab="items">Items</button>
          <button class="tab active" data-tab="counts">Counts</button>
          <button class="tab" data-tab="reports">Reports</button>
        </div>

        <div class="divider"></div>

        <div class="field">
          <label for="monthSelect">Inventory Month</label>
          <select id="monthSelect"></select>
          <div class="hint">Pick the month youâ€™re counting. Counts are stored per month.</div>
        </div>

        <div class="divider"></div>

        <div class="hint">
          <b>Workflow:</b><br>
          1) Keep your master list clean in <b>Items</b><br>
          2) Once/month, enter counts in <b>Counts</b><br>
          3) Send Accounting the <b>Grand Total Value</b> from <b>Reports</b>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="hd">
        <h2 id="mainTitle">Counts</h2>
        <div class="actions" id="mainActions"></div>
      </div>
      <div class="bd" id="mainBody"></div>
    </div>
  </div>
</div>

<div class="toast" id="toast"><div class="msg" id="toastMsg"></div></div>

<!-- Auth modal -->
<div id="authModal" class="modal" style="display:none;">
  <div class="modalCard">
    <div style="display:flex; justify-content:space-between; align-items:center; gap:12px;">
      <h3 style="margin:0;">Sign in (Cloud Sync)</h3>
      <button id="authModalClose" class="btn">âœ•</button>
    </div>
    <p class="hint" style="margin:8px 0 12px;">
      Enter your email and youâ€™ll receive a magic link. Click it to sign in.
    </p>
    <div class="row" style="gap:10px; align-items:flex-end;">
      <div class="field" style="flex:1;">
        <label>Email</label>
        <input id="authEmail" placeholder="name@columbia.edu" />
      </div>
      <button id="authSend" class="btn primary">Send Link</button>
    </div>
    <div class="divider"></div>
    <p class="hint" id="authMsg" style="margin:0;"></p>
  </div>
</div>

<script>
(() => {
  // ====== VERSION ======
  const APP_VERSION = "vPROD-2";

  // ====== SUPABASE CONFIG ======
  const SUPABASE_URL = "https://yvznkaitcorhfoutfkmk.supabase.co";
  // Use the anon public key (JWT) for supabase-js createClient.
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl2em5rYWl0Y29yaGZvdXRma21rIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAyMjk0NTksImV4cCI6MjA4NTgwNTQ1OX0.MbCJiFh_O4WEfiEpVfeRo7FWF9rac-C-eJR4k8rgleE";
  const CLOUD_ROW_ID = 1; // single shared row

  const hasSupabaseConfig = () => /^https?:\/\//i.test(SUPABASE_URL) && SUPABASE_ANON_KEY.length > 30;

  let sb = null;
  let cloudMode = false;

  // ====== APP STORAGE ======
  const STORE_KEY = "fh_inv_live_v8_clean";
  const DEFAULT_CATEGORIES = [
    "White Wine","Red Wine","Sparkling Wine",
    "Beer",
    "Vodka","Whiskey","Tequila","Gin","Rum","Cordials/Other"
  ];

  const $ = (sel, root=document) => root.querySelector(sel);
  const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
  const fmtMoney = (n) => Number(n||0).toLocaleString(undefined,{style:"currency",currency:"USD"});
  const fmtNum = (n) => Number(n||0).toLocaleString(undefined,{maximumFractionDigits:2});
  const toast = (msg) => {
    $("#toastMsg").textContent = msg;
    $("#toast").classList.add("show");
    clearTimeout(toast._t);
    toast._t = setTimeout(()=>$("#toast").classList.remove("show"), 2200);
  };
  const uuid = () => "i_" + Math.random().toString(16).slice(2) + Date.now().toString(16);
  const escapeHtml = (s)=>String(s??"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;");
  const round2 = (n)=>Math.round((Number(n||0)+Number.EPSILON)*100)/100;

  function isValidMonth(s){ return typeof s === "string" && /^\d{4}-\d{2}$/.test(s); }
  function yyyymmFromDate(d){ return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}`; }
  function prevMonth(yyyymm){
    const [y,m] = (yyyymm||yyyymmFromDate(new Date())).split("-").map(Number);
    const dt = new Date(y, m-1, 1);
    dt.setMonth(dt.getMonth()-1);
    return yyyymmFromDate(dt);
  }
  function addMonths(yyyymm, delta){
    if(!isValidMonth(yyyymm)) return yyyymmFromDate(new Date());
    const [y,m] = yyyymm.split("-").map(Number);
    const d = new Date(y, m-1, 1);
    d.setMonth(d.getMonth()+delta);
    return yyyymmFromDate(d);
  }

  const isSpiritType = (cat) => ["Vodka","Whiskey","Tequila","Gin","Rum","Cordials/Other"].includes(cat);

  function defaultState(){
    const now=new Date();
    const thisMonth=yyyymmFromDate(now);
    const lastMonth=prevMonth(thisMonth);

    // Keep a few sample items so a fresh install isn't blank.
    const items=[
      {id:uuid(),name:"CAVIT PG",category:"White Wine",unit_cost:6.11,uom:"btl",active:true},
      {id:uuid(),name:"KIM CRAWFORD SB large",category:"White Wine",unit_cost:13.50,uom:"btl",active:true},
      {id:uuid(),name:"KOSHER CHARD",category:"White Wine",unit_cost:10.21,uom:"btl",active:true},
      {id:uuid(),name:"STELLA",category:"Beer",unit_cost:1.29,uom:"cs",active:true},
      {id:uuid(),name:"GREYGOOSE",category:"Vodka",unit_cost:38.29,uom:"btl",active:true},
    ];

    const counts={}; counts[lastMonth]={}; counts[thisMonth]={};
    items.forEach((it,idx)=>{ counts[lastMonth][it.id]=idx%2===0?4:7; counts[thisMonth][it.id]=idx%2===0?5:6; });

    return {
      version: 2,
      items,
      counts,
      monthPrices: {},
      finalizedMonths: {},
      settings: { monthsToShow: 12, categories: DEFAULT_CATEGORIES.slice(), lastCategory: null }
    };
  }

  function loadState(){
    try{
      const raw = localStorage.getItem(STORE_KEY);
      if(!raw) return defaultState();
      const s = JSON.parse(raw);
      if(!s || typeof s !== "object") return defaultState();
      if(s.version !== 2) return defaultState();
      if(!Array.isArray(s.items)) s.items = [];
      if(!s.counts || typeof s.counts !== "object") s.counts = {};
      if(!s.monthPrices || typeof s.monthPrices !== "object") s.monthPrices = {};
      if(!s.finalizedMonths || typeof s.finalizedMonths !== "object") s.finalizedMonths = {};
      if(!s.settings) s.settings = {monthsToShow:12, categories: DEFAULT_CATEGORIES.slice(), lastCategory:null};
      if(!Array.isArray(s.settings.categories) || s.settings.categories.length===0){
        s.settings.categories = DEFAULT_CATEGORIES.slice();
      }else{
        DEFAULT_CATEGORIES.forEach(c => { if(!s.settings.categories.includes(c)) s.settings.categories.push(c); });
      }
      if(s.settings.lastCategory === undefined) s.settings.lastCategory = null;
      return s;
    }catch(e){
      return defaultState();
    }
  }

  let state = loadState();
  let currentTab = "counts";
  let selectedMonth = null;

  function saveState(){
    localStorage.setItem(STORE_KEY, JSON.stringify(state));
    $("#pillItems").textContent = String(state.items.filter(i=>i.active).length);
  }

  function catOrderIndex(cat){
    const cats = (state?.settings?.categories || DEFAULT_CATEGORIES);
    const idx = cats.indexOf(cat);
    return idx === -1 ? 999 : idx;
  }

  function buildMonthOptions(){
    const sel = $("#monthSelect");
    sel.innerHTML = "";
    const now = new Date();
    const cur = yyyymmFromDate(now);

    const real = new Set();
    Object.keys(state.counts||{}).forEach(k=>{ if(isValidMonth(k)) real.add(k); });
    Object.keys(state.monthPrices||{}).forEach(k=>{ if(isValidMonth(k)) real.add(k); });

    [cur, addMonths(cur,1), addMonths(cur,2), addMonths(cur,3)].forEach(m=>real.add(m));
    if(selectedMonth && isValidMonth(selectedMonth)) real.add(selectedMonth);

    const months = Array.from(real).sort();
    months.forEach(m=>{
      const opt = document.createElement("option");
      opt.value = m;
      opt.textContent = m;
      sel.appendChild(opt);
    });

    if(!selectedMonth || !real.has(selectedMonth)) selectedMonth = cur;
    sel.value = selectedMonth;
    $("#pillMonth").textContent = selectedMonth;
  }

  function ensureMonthPriceSnapshot(month){
    if(!month) return;
    if(!state.monthPrices) state.monthPrices = {};
    if(!state.monthPrices[month]){
      state.monthPrices[month] = {};
      state.items.forEach(it => { state.monthPrices[month][it.id] = Number(it.unit_cost||0); });
      saveState();
      cloudSaveState();
    }
  }

  function getUnitCostForMonth(it, month){
    ensureMonthPriceSnapshot(month);
    const snap = state.monthPrices?.[month]?.[it.id];
    return (snap === undefined || snap === null) ? Number(it.unit_cost||0) : Number(snap||0);
  }

  function setUnitCostForMonth(itOrId, month, v){
    const itemId = typeof itOrId === "object" ? itOrId.id : itOrId;
    if(!itemId || !month) return;
    if(!state.monthPrices) state.monthPrices = {};
    if(!state.monthPrices[month]) state.monthPrices[month] = {};
    const vNum = (v === "" || v === null || typeof v === "undefined") ? null : Number(v);
    if(vNum === null || Number.isNaN(vNum)){
      delete state.monthPrices[month][itemId];
    }else{
      state.monthPrices[month][itemId] = vNum;
    }
    saveState();
    cloudSaveState();
  }

  function computeTotalsForMonth(month){
    const byCategory={}; let grandTotal=0;
    const items=state.items.filter(i=>i.active);
    const counts=(state.counts[month]||{});
    for(const it of items){
      const c=Number(counts[it.id]??0);
      const uc=getUnitCostForMonth(it, month);
      const v=c*uc;
      const cat=it.category||"Other";
      byCategory[cat]=(byCategory[cat]||0)+v;
      grandTotal+=v;
    }
    return {byCategory, grandTotal: round2(grandTotal)};
  }

  function isMonthFinalized(month){
    return !!(state.finalizedMonths && state.finalizedMonths[month]);
  }

  function setTitle(t){ $("#mainTitle").textContent=t; }
  function setActions(nodes){ const host=$("#mainActions"); host.innerHTML=""; nodes.forEach(n=>host.appendChild(n)); }

  function mkBtn(text, cls="", onClick=()=>{}){
    const b=document.createElement("button");
    b.className="btn"+(cls?" "+cls:"");
    b.textContent=text;
    b.onclick=onClick;
    return b;
  }

  // ====== CLOUD ======
  function syncCloudUI(){
    const statusEl = $("#cloudStatus");
    const authBtn = $("#authBtn");
    if(!statusEl || !authBtn) return;

    if(!hasSupabaseConfig()){
      statusEl.style.display="none";
      authBtn.style.display="none";
      return;
    }

    statusEl.style.display="inline-flex";
    authBtn.style.display="inline-flex";

    if(cloudMode){
      statusEl.classList.add("good");
      statusEl.classList.remove("bad");
      statusEl.textContent = "Cloud: signed in";
      authBtn.textContent = "Sign out";
    }else{
      statusEl.classList.remove("good");
      statusEl.classList.add("bad");
      statusEl.textContent = "Cloud: not signed in";
      authBtn.textContent = "Sign in";
    }
  }

  function openAuthModal(){
    const m=$("#authModal");
    const closeBtn=$("#authModalClose");
    const sendBtn=$("#authSend");
    const emailEl=$("#authEmail");
    const msg=$("#authMsg");
    if(!m||!sendBtn||!emailEl||!msg) return;

    msg.textContent="";
    m.style.display="flex";
    emailEl.value="";
    setTimeout(()=>emailEl.focus(),50);

    const close=()=>{ m.style.display="none"; };
    closeBtn.onclick=close;
    m.onclick=(e)=>{ if(e.target===m) close(); };

    sendBtn.onclick=async ()=>{
      const email=(emailEl.value||"").trim();
      if(!email){ msg.textContent="Please enter an email."; return; }
      if(!/@columbia\\.edu$/i.test(email)){ msg.textContent="Use your @columbia.edu email."; return; }
      if(!sb||!sb.auth){ msg.textContent="Cloud not ready yet."; return; }

      sendBtn.disabled=true;
      msg.textContent="Sendingâ€¦";

      try{
        const { error } = await sb.auth.signInWithOtp({
          email,
          options:{ emailRedirectTo: window.location.href.split("#")[0] + "#" }
        });
        msg.textContent = error ? ("Error: " + error.message) : "Check your inbox for the magic link.";
      }catch(err){
        console.error(err);
        msg.textContent="Error sending link.";
      }finally{
        sendBtn.disabled=false;
      }
    };
  }

  async function cloudLoadIntoState(){
    if(!sb) return;
    try{
      const { data, error } = await sb
        .from("inventory_state")
        .select("state_json")
        .eq("id", CLOUD_ROW_ID)
        .single();

      if(error){
        console.warn("Cloud load error:", error);
        toast("Cloud load failed (using local)");
        return;
      }
      if(data && data.state_json && typeof data.state_json === "object"){
        state = data.state_json;

        // ensure structure
        if(!Array.isArray(state.items)) state.items = [];
        if(!state.counts || typeof state.counts !== "object") state.counts = {};
        if(!state.monthPrices || typeof state.monthPrices !== "object") state.monthPrices = {};
        if(!state.finalizedMonths || typeof state.finalizedMonths !== "object") state.finalizedMonths = {};
        if(!state.settings) state.settings = {monthsToShow:12, categories: DEFAULT_CATEGORIES.slice(), lastCategory:null};

        saveState();
      }
    }catch(e){
      console.warn("Cloud load exception:", e);
      toast("Cloud load failed (using local)");
    }
  }

  async function cloudSaveState(){
    if(!cloudMode || !sb) return;
    try{
      const payload = { id: CLOUD_ROW_ID, state_json: state };
      const { error } = await sb.from("inventory_state").upsert(payload, { onConflict:"id" });
      if(error){
        console.warn("Cloud save error:", error);
        toast("Cloud save failed (saved locally)");
      }
    }catch(e){
      console.warn("Cloud save exception:", e);
      toast("Cloud save failed (saved locally)");
    }
  }

  async function initSupabase(){
    if(!hasSupabaseConfig()){
      cloudMode = false;
      syncCloudUI();
      return;
    }
    if(!(window.supabase && typeof window.supabase.createClient === "function")){
      console.warn("supabase-js not loaded");
      cloudMode = false;
      syncCloudUI();
      return;
    }

    sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: { persistSession:true, autoRefreshToken:true, detectSessionInUrl:true }
    });

    // session
    const { data: sessionData } = await sb.auth.getSession();
    cloudMode = !!sessionData?.session;
    syncCloudUI();

    // button behavior
    $("#authBtn").onclick = async ()=>{
      if(!sb) return;
      if(cloudMode){
        await sb.auth.signOut();
        cloudMode = false;
        syncCloudUI();
        toast("Signed out");
      }else{
        openAuthModal();
      }
    };

    // auth change listener
    sb.auth.onAuthStateChange(async (_event, newSession) => {
      cloudMode = !!newSession;
      syncCloudUI();
      if(cloudMode){
        await cloudLoadIntoState();
        buildMonthOptions();
        ensureMonthPriceSnapshot(selectedMonth);
        render();
        toast("Cloud synced");
      }
    });

    // if already signed in, load cloud state once
    if(cloudMode){
      await cloudLoadIntoState();
    }
  }

  // ====== UI ======
  function render(){
    $("#appVersionBadge").textContent = APP_VERSION;

    $("#pillMonth").textContent = selectedMonth || "â€”";
    $("#pillItems").textContent = String(state.items.filter(i=>i.active).length);
    $$(".tab").forEach(t=>t.classList.toggle("active", t.dataset.tab===currentTab));

    if(currentTab==="items") renderItems();
    if(currentTab==="counts") renderCounts();
    if(currentTab==="reports") renderReports();
  }

  function renderItems(){
    setTitle("Items");
    const addBtn = mkBtn("âž• Add Item","primary",()=>openItemEditor());
    setActions([addBtn]);

    const body=$("#mainBody");
    body.innerHTML=`
      <div class="row" style="justify-content:space-between; align-items:flex-end;">
        <div class="field" style="min-width:260px;">
          <label>Search</label>
          <input id="itemSearch" placeholder="Type to filter itemsâ€¦" />
        </div>
        <div class="field" style="min-width:220px;">
          <label>Show</label>
          <select id="itemFilter">
            <option value="active" selected>Active items</option>
            <option value="all">All items</option>
            <option value="inactive">Inactive only</option>
          </select>
        </div>
      </div>
      <div class="divider"></div>
      <div class="hint">If the Actions buttons are tight, scroll the table left/right â€” the Actions column stays pinned on the right.</div>
      <div class="divider"></div>
      <div class="tablewrap">
        <table>
          <thead>
            <tr>
              <th style="min-width:240px;">Item</th>
              <th style="min-width:120px;">Category</th>
              <th style="min-width:80px;">UOM</th>
              <th class="right" style="min-width:120px;">Unit Cost</th>
              <th style="min-width:160px;">Status</th>
              <th class="right sticky-r" style="min-width:180px;">Actions</th>
            </tr>
          </thead>
          <tbody id="itemsTbody"></tbody>
        </table>
      </div>
    `;

    const search=$("#itemSearch");
    const filter=$("#itemFilter");

    const rerenderRows=()=>{
      const q=(search.value||"").trim().toLowerCase();
      const f=filter.value;
      const rows=state.items.slice().sort((a,b)=>{
        const d=catOrderIndex(a.category)-catOrderIndex(b.category);
        return d!==0 ? d : (a.name||"").localeCompare(b.name||"");
      }).filter(it=>{
        if(f==="active" && !it.active) return false;
        if(f==="inactive" && it.active) return false;
        if(!q) return true;
        return (it.name||"").toLowerCase().includes(q) || (it.category||"").toLowerCase().includes(q);
      });

      const tb=$("#itemsTbody"); tb.innerHTML="";
      rows.forEach(it=>tb.appendChild(itemRow(it)));
      if(rows.length===0) tb.innerHTML=`<tr><td colspan="6" style="color:rgba(255,255,255,.7);font-size:13px;">No matching items.</td></tr>`;
    };

    search.addEventListener("input", rerenderRows);
    filter.addEventListener("change", rerenderRows);
    rerenderRows();
  }

  function itemRow(it){
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td><b>${escapeHtml(it.name)}</b></td>
      <td>${escapeHtml(it.category||"")}</td>
      <td class="mono">${escapeHtml(it.uom||"")}</td>
      <td class="right mono">${fmtMoney(it.unit_cost)}</td>
      <td>${it.active?`<span class="badge good">Active</span>`:`<span class="badge bad">Inactive</span>`}</td>
      <td class="right sticky-r"></td>
    `;
    const td=tr.lastElementChild;
    const edit=mkBtn("Edit","",()=>openItemEditor(it));
    const toggle=mkBtn(it.active?"Deactivate":"Activate","",()=>{
      it.active=!it.active; saveState(); cloudSaveState(); render(); toast(it.active?"Item activated":"Item deactivated");
    });
    const del=mkBtn("Delete","danger",()=>{
      if(!confirm(`Delete \"${it.name}\"?\n\nThis removes it completely (including stored counts).`)) return;
      Object.keys(state.counts||{}).forEach(m=>{ if(state.counts[m]) delete state.counts[m][it.id]; });
      state.items=state.items.filter(x=>x.id!==it.id);
      saveState(); cloudSaveState(); render(); toast("Item deleted");
    });
    const wrap=document.createElement("div");
    wrap.style.display="flex"; wrap.style.gap="8px"; wrap.style.justifyContent="flex-end"; wrap.style.flexWrap="wrap";
    wrap.append(edit,toggle,del);
    td.appendChild(wrap);
    return tr;
  }

  function openItemEditor(existing=null){
    const isEdit=!!existing;
    const it=existing?{...existing}:{id:uuid(),name:"",category:(state.settings.lastCategory||"Beer"),unit_cost:0,uom:"btl",active:true};
    const body=$("#mainBody");
    body.innerHTML=`
      <div class="row">
        <div class="field" style="min-width:320px; flex:1;">
          <label>Item Name</label>
          <input id="editName" placeholder="e.g., Tito's 1L" />
        </div>
        <div class="field" style="min-width:180px;">
          <label>Category</label>
          <select id="editCategory"></select>
          <div class="hint" style="margin-top:6px;"><strong>Category controls where this item appears on the Counts screen.</strong><br/>(Reports still roll everything up to Wine, Beer, and Spirits.)</div>
        </div>
        <div class="field" style="min-width:120px;">
          <label>UOM</label>
          <input id="editUom" placeholder="btl/cs/keg" />
        </div>
        <div class="field" style="min-width:160px;">
          <label>Unit Cost</label>
          <input id="editCost" type="number" step="0.01" min="0" />
        </div>
        <div class="field" style="min-width:160px;">
          <label>Status</label>
          <select id="editActive">
            <option value="true">Active</option>
            <option value="false">Inactive</option>
          </select>
        </div>
      </div>
      <div class="divider"></div>
      <div class="actions">
        <button class="btn" id="cancelEdit">Cancel</button>
        <button class="btn primary" id="saveEdit">${isEdit?"Save Changes":"Add Item"}</button>
      </div>
    `;

    const catSel=$("#editCategory");
    const cats = (state.settings.categories || []).slice().sort((a,b)=>a.localeCompare(b));
    cats.forEach(c=>{ const opt=document.createElement("option"); opt.value=c; opt.textContent=c; catSel.appendChild(opt); });
    const addOpt=document.createElement("option"); addOpt.value="__ADD__"; addOpt.textContent="âž• Add new categoryâ€¦"; catSel.appendChild(addOpt);

    $("#editName").value=it.name;
    $("#editCategory").value = it.category || (state.settings.lastCategory || (state.settings.categories||[])[0] || "Beer");
    $("#editUom").value=it.uom||"";
    $("#editCost").value=Number(it.unit_cost||0);
    $("#editActive").value=String(!!it.active);

    $("#editCategory").onchange=()=>{
      if($("#editCategory").value==="__ADD__"){
        const name = prompt("New category name (e.g., White Wine, Vodka, Gin):");
        const clean = (name||"").trim();
        if(!clean){ $("#editCategory").value = it.category || (state.settings.lastCategory || "Beer"); return; }
        if(!state.settings.categories.includes(clean)) state.settings.categories.push(clean);
        saveState(); cloudSaveState();
        openItemEditor(existing);
      }
    };

    $("#cancelEdit").onclick=()=>render();
    $("#saveEdit").onclick=()=>{
      const name=($("#editName").value||"").trim();
      if(!name){ toast("Item name is required"); return; }
      it.name=name;
      it.category=($("#editCategory").value==="__ADD__" ? (it.category||"Beer") : $("#editCategory").value);
      state.settings.lastCategory = it.category;
      it.uom=($("#editUom").value||"").trim();
      it.unit_cost=Number($("#editCost").value||0);
      it.active=$("#editActive").value==="true";

      if(isEdit){
        const idx=state.items.findIndex(x=>x.id===existing.id);
        if(idx >= 0) state.items[idx]=it;
        toast("Item updated");
      }else{
        state.items.push(it);
        toast(`New item added to ${it.category || "Category"}`);
      }
      saveState(); cloudSaveState();
      currentTab = "items";
      render();
    };
  }

  function clearCountsForMonth(month){
    if(!month) return;
    if(isMonthFinalized(month)){ toast("Month is finalized (locked)."); return; }
    if(!confirm(`Clear ALL counts for ${month}?\n\nThis sets every item to 0 for this month.`)) return;
    if(!state.counts) state.counts = {};
    state.counts[month] = {};
    (state.items||[]).forEach(it => { state.counts[month][it.id] = 0; });
    saveState(); cloudSaveState();
    render();
    toast(`Cleared counts for ${month}`);
  }

  function copyPreviousMonthCounts(){
    const month = selectedMonth;
    if(!month){ toast("Pick a month first"); return; }
    const pmonth = prevMonth(month);
    if(!confirm(`Copy counts from ${pmonth} into ${month}?\n\nThis overwrites the current month's counts (you can still edit after).`)) return;

    if(!state.counts[month]) state.counts[month] = {};
    if(!state.counts[pmonth]) state.counts[pmonth] = {};

    const activeItems = state.items.filter(i=>i.active);
    ensureMonthPriceSnapshot(month);

    activeItems.forEach(it=>{
      const prev = Number(state.counts[pmonth][it.id] ?? 0);
      const cat = it.category || "Uncategorized";
      const val = isSpiritType(cat) ? prev : Math.round(prev);
      state.counts[month][it.id] = val;
    });

    saveState(); cloudSaveState();
    toast("Previous month copied");
    currentTab = "counts";
    render();
  }

  function renderCounts(){
    setTitle("Counts");
    const body=$("#mainBody");
    const month=selectedMonth;

    if(!month){
      body.innerHTML=`<div class="hint">Pick a month.</div>`;
      setActions([]);
      return;
    }

    const pmonth = prevMonth(month);
    if(!state.counts[month]) state.counts[month]={};
    if(!state.counts[pmonth]) state.counts[pmonth]={};

    // Actions row
    const btnFinalize = isMonthFinalized(month)
      ? mkBtn("ðŸ”“ Unlock Month","",()=>{
          if(!confirm(`Unlock ${month}? This allows edits.`)) return;
          delete state.finalizedMonths[month];
          saveState(); cloudSaveState(); render();
          toast("Month unlocked");
        })
      : mkBtn("âœ… Finalize Month","",()=>{
          if(!confirm(`Finalize ${month}? This will make it read-only by default.`)) return;
          state.finalizedMonths[month] = true;
          saveState(); cloudSaveState(); render();
          toast("Month finalized");
        });

    const btnCopyPrev = mkBtn("â†©ï¸Ž Copy Prev Month","",()=>copyPreviousMonthCounts());
    const btnClear = mkBtn("ðŸ§¹ Clear Counts","danger",()=>clearCountsForMonth(month));
    const btnSave = mkBtn("ðŸ’¾ Save Counts","primary",()=>{
      saveState(); cloudSaveState();
      toast("Counts saved");
    });

    setActions([btnFinalize, btnCopyPrev, btnClear, btnSave]);

    const allItems = state.items.filter(i=>i.active).slice().sort((a,b)=>{
      const d=catOrderIndex(a.category)-catOrderIndex(b.category);
      return d!==0 ? d : (a.name||"").localeCompare(b.name||"");
    });

    body.innerHTML = `
      <div class="row" style="justify-content:space-between; align-items:flex-end;">
        <div class="field" style="min-width:260px; flex:1;">
          <label>Search (optional)</label>
          <input id="countSearch" placeholder="Type to filter itemsâ€¦" />
          <div class="hint">Entry order stays category â†’ alphabetical. Keyboard: <b>Enter</b> next, <b>Shift+Enter</b> previous, <b>â†‘/â†“</b> move.</div>
        </div>
        <div class="field" style="min-width:220px;">
          <label>Month</label>
          <div class="pill" style="justify-content:space-between;">
            <span class="mono">${month}</span>
            <span style="color:var(--muted);">Prev: <span class="mono">${pmonth}</span></span>
          </div>
        </div>
      </div>

      <div class="divider"></div>

      <div class="kpis" id="countsKpis"></div>

      <div class="divider"></div>

      <div id="countsGroups"></div>
    `;

    const search=$("#countSearch");
    const groupsHost=$("#countsGroups");

    function getFilteredItems(){
      const q=(search.value||"").trim().toLowerCase();
      if(!q) return allItems;
      return allItems.filter(it => (it.name||"").toLowerCase().includes(q) || (it.category||"").toLowerCase().includes(q));
    }

    function computeGroupedTotals(items){
      const totalsByCat = {};
      const prevByCat = {};
      let totalCur=0, totalPrev=0;

      items.forEach(it=>{
        const cat = it.category || "Uncategorized";
        const prev = Number((state.counts[pmonth]||{})[it.id] ?? 0);
        const cur  = Number((state.counts[month]||{})[it.id] ?? 0);
        const uc   = getUnitCostForMonth(it, month);
        const prevVal = prev * uc;
        const curVal  = cur * uc;

        totalsByCat[cat] = (totalsByCat[cat]||0) + curVal;
        prevByCat[cat]   = (prevByCat[cat]||0) + prevVal;
        totalCur += curVal;
        totalPrev += prevVal;
      });

      const wineCur = (totalsByCat["White Wine"]||0)+(totalsByCat["Red Wine"]||0)+(totalsByCat["Sparkling Wine"]||0);
      const winePrev = (prevByCat["White Wine"]||0)+(prevByCat["Red Wine"]||0)+(prevByCat["Sparkling Wine"]||0);
      const beerCur = (totalsByCat["Beer"]||0);
      const beerPrev = (prevByCat["Beer"]||0);
      const spiritsCur =
        (totalsByCat["Vodka"]||0)+(totalsByCat["Whiskey"]||0)+(totalsByCat["Tequila"]||0)+
        (totalsByCat["Gin"]||0)+(totalsByCat["Rum"]||0)+(totalsByCat["Cordials/Other"]||0);
      const spiritsPrev =
        (prevByCat["Vodka"]||0)+(prevByCat["Whiskey"]||0)+(prevByCat["Tequila"]||0)+
        (prevByCat["Gin"]||0)+(prevByCat["Rum"]||0)+(prevByCat["Cordials/Other"]||0);

      return { totalCur, totalPrev, wineCur, winePrev, beerCur, beerPrev, spiritsCur, spiritsPrev };
    }

    function renderKpis(items){
      const t = computeGroupedTotals(items);
      $("#countsKpis").innerHTML = `
        <div class="kpi"><div class="t">Grand Total Value</div><div class="v">${fmtMoney(t.totalCur)}</div><div class="s">Prev: ${fmtMoney(t.totalPrev)} | Î” ${fmtMoney(t.totalCur - t.totalPrev)}</div></div>
        <div class="kpi"><div class="t">Wine Total</div><div class="v">${fmtMoney(t.wineCur)}</div><div class="s">Prev: ${fmtMoney(t.winePrev)} | Î” ${fmtMoney(t.wineCur - t.winePrev)}</div></div>
        <div class="kpi"><div class="t">Beer Total</div><div class="v">${fmtMoney(t.beerCur)}</div><div class="s">Prev: ${fmtMoney(t.beerPrev)} | Î” ${fmtMoney(t.beerCur - t.beerPrev)}</div></div>
        <div class="kpi"><div class="t">Spirits Total</div><div class="v">${fmtMoney(t.spiritsCur)}</div><div class="s">Prev: ${fmtMoney(t.spiritsPrev)} | Î” ${fmtMoney(t.spiritsCur - t.spiritsPrev)}</div></div>
      `;
    }

    function makeRow(it){
      const cat = it.category || "Uncategorized";
      const prev = Number((state.counts[pmonth]||{})[it.id] ?? 0);
      const cur  = Number((state.counts[month]||{})[it.id] ?? 0);
      const variance = cur - prev;

      const row = document.createElement("div");
      row.style.display="grid";
      row.style.gridTemplateColumns="1.6fr 110px 140px 110px 120px 140px";
      row.style.gap="10px";
      row.style.alignItems="center";
      row.style.padding="10px 8px";
      row.style.borderBottom="1px solid rgba(255,255,255,.08)";

      row.innerHTML = `
        <div style="min-width:0;">
          <div style="font-weight:800; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${escapeHtml(it.name||"")}</div>
          <div class="hint" style="margin-top:2px;">${escapeHtml(cat)} â€¢ <span class="mono">${escapeHtml(it.uom||"")}</span></div>
        </div>
        <div class="right mono" data-prev>${fmtNum(prev)}</div>
        <div class="right" data-inputcell></div>
        <div class="right mono" data-var>${variance===0?"0":(variance>0?("+"+fmtNum(variance)):fmtNum(variance))}</div>
        <div class="right" data-costcell></div>
        <div class="right mono" data-line>${fmtMoney(cur*getUnitCostForMonth(it, month))}</div>
      `;

      const inputCell = row.querySelector("[data-inputcell]");
      const inp = document.createElement("input");
      inp.type="number";
      inp.inputMode="decimal";
      inp.value=String(cur);
      inp.dataset.itemid = it.id;

      if(isSpiritType(cat)){
        inp.step = "0.01";
        inp.placeholder = "0.00";
      }else{
        inp.step = "1";
        inp.placeholder = "0";
      }
      inp.style.textAlign="right";
      inp.style.fontWeight="800";
      inp.style.fontSize="14px";
      inp.style.padding="10px 10px";

      function normalizeIfNeeded(finalize=false){
        const v = Number(inp.value||0);
        if(!isSpiritType(cat)){ // must be integer
          const isInt = Number.isInteger(v);
          if(!isInt){
            inp.style.borderColor = "rgba(255,204,102,.65)";
            if(finalize){
              const rounded = Math.round(v);
              inp.value = String(rounded);
              state.counts[month][it.id] = rounded;
              toast("Wine/Beer must be whole bottles â€” rounded.");
            }
          }else{
            inp.style.borderColor = "";
          }
        }else{
          inp.style.borderColor = "";
        }
      }

      if(isMonthFinalized(month)){
        inp.disabled=true;
        inp.style.opacity="0.6";
      }

      inp.addEventListener("input", ()=>{
        const v = Number(inp.value||0);
        state.counts[month][it.id] = v;

        const prevNow = Number((state.counts[pmonth]||{})[it.id] ?? 0);
        const varianceNow = v - prevNow;
        row.querySelector("[data-var]").textContent = varianceNow===0?"0":(varianceNow>0?("+"+fmtNum(varianceNow)):fmtNum(varianceNow));
        row.querySelector("[data-line]").textContent = fmtMoney(v*getUnitCostForMonth(it, month));

        normalizeIfNeeded(false);
        renderKpis(getFilteredItems());
      });

      inp.addEventListener("blur", ()=> normalizeIfNeeded(true));

      inp.addEventListener("keydown", (e)=>{
        const key = e.key;
        if(key === "Enter" || key === "ArrowDown" || key === "ArrowUp"){
          e.preventDefault();
          const inputs = Array.from(document.querySelectorAll('input[data-itemid]'));
          const idx = inputs.indexOf(inp);
          if(idx === -1) return;
          let nextIdx = idx;
          if(key === "ArrowDown" || (key==="Enter" && !e.shiftKey)) nextIdx = Math.min(inputs.length-1, idx+1);
          if(key === "ArrowUp" || (key==="Enter" && e.shiftKey)) nextIdx = Math.max(0, idx-1);
          inputs[nextIdx].focus();
          inputs[nextIdx].select();
        }
      });

      // Unit cost per-month
      const costCell = row.querySelector("[data-costcell]");
      const costInp = document.createElement("input");
      costInp.type="number";
      costInp.step="0.01";
      costInp.min="0";
      costInp.value = String(getUnitCostForMonth(it, month));
      costInp.style.textAlign="right";
      costInp.style.padding="8px 10px";
      costInp.style.fontSize="12px";
      costInp.style.fontWeight="700";
      costInp.title = "Unit cost for this month (overrides master price)";
      costInp.addEventListener("input", ()=>{
        const v = Number(costInp.value||0);
        setUnitCostForMonth(it.id, month, v);
        const curNow = Number(state.counts[month][it.id] ?? 0);
        row.querySelector("[data-line]").textContent = fmtMoney(curNow*v);
        renderKpis(getFilteredItems());
      });
      if(isMonthFinalized(month)){
        costInp.disabled = true;
        costInp.style.opacity="0.6";
      }

      costCell.appendChild(costInp);
      inputCell.appendChild(inp);
      return row;
    }

    function renderGroups(){
      const items = getFilteredItems();
      renderKpis(items);

      const groups = {};
      items.forEach(it=>{
        const cat = it.category || "Uncategorized";
        if(!groups[cat]) groups[cat]=[];
        groups[cat].push(it);
      });

      const cats = (state.settings.categories || DEFAULT_CATEGORIES).filter(c=>groups[c] && groups[c].length>0);
      groupsHost.innerHTML = "";

      cats.forEach(cat=>{
        const card = document.createElement("div");
        card.className="card";
        card.style.marginBottom="12px";
        card.innerHTML = `
          <div class="hd"><h2>${escapeHtml(cat)}</h2></div>
          <div class="bd" style="padding:0;">
            <div style="display:grid; grid-template-columns:1.6fr 110px 140px 110px 120px 140px; gap:10px; padding:10px 8px; border-bottom:1px solid rgba(255,255,255,.10); color:var(--muted); font-size:12px;">
              <div>Item</div>
              <div class="right">Prev</div>
              <div class="right">This Month</div>
              <div class="right">Var</div>
              <div class="right">Unit Cost</div>
              <div class="right">Line Value</div>
            </div>
            <div data-rows></div>
          </div>
        `;
        const rowsHost = card.querySelector("[data-rows]");
        groups[cat].slice().sort((a,b)=>(a.name||"").localeCompare(b.name||"")).forEach(it=> rowsHost.appendChild(makeRow(it)));
        groupsHost.appendChild(card);
      });

      if(!renderGroups._didFocusOnce){
        const active = document.activeElement;
        const typingInSearch = active && active.id === "countSearch";
        if(!typingInSearch){
          const first = groupsHost.querySelector('input[data-itemid]');
          if(first){ first.focus(); first.select(); renderGroups._didFocusOnce=true; }
        }
      }
    }

    search.addEventListener("input", ()=> renderGroups());
    renderGroups();
  }

  function renderReports(){
    setTitle("Reports");
    setActions([]);

    const totals=computeTotalsForMonth(selectedMonth);
    const wineTotal=(totals.byCategory["White Wine"]||0)+(totals.byCategory["Red Wine"]||0)+(totals.byCategory["Sparkling Wine"]||0);
    const beerTotal=(totals.byCategory["Beer"]||0);
    const spiritsTotal=
      (totals.byCategory["Vodka"]||0)+(totals.byCategory["Whiskey"]||0)+(totals.byCategory["Tequila"]||0)+
      (totals.byCategory["Gin"]||0)+(totals.byCategory["Rum"]||0)+(totals.byCategory["Cordials/Other"]||0);

    const body=$("#mainBody");
    const catRows=Object.keys(totals.byCategory).sort().map(cat=>({cat,val:totals.byCategory[cat]}));
    body.innerHTML=`
      <div class="kpis">
        <div class="kpi"><div class="t">Month</div><div class="v mono">${selectedMonth||"â€”"}</div><div class="s">Ending value</div></div>
        <div class="kpi"><div class="t">Grand Total Inventory Value</div><div class="v">${fmtMoney(totals.grandTotal)}</div><div class="s">Send this to Accounting</div></div>
        <div class="kpi"><div class="t">Wine Total</div><div class="v">${fmtMoney(wineTotal)}</div><div class="s">White + Red + Sparkling</div></div>
        <div class="kpi"><div class="t">Beer Total</div><div class="v">${fmtMoney(beerTotal)}</div><div class="s">All beer</div></div>
      </div>
      <div class="kpis" style="margin-top:10px;">
        <div class="kpi"><div class="t">Spirits Total</div><div class="v">${fmtMoney(spiritsTotal)}</div><div class="s">All spirits (bundled)</div></div>
        <div class="kpi"><div class="t">White Wine</div><div class="v">${fmtMoney(totals.byCategory["White Wine"]||0)}</div><div class="s">Subtotal</div></div>
        <div class="kpi"><div class="t">Red Wine</div><div class="v">${fmtMoney(totals.byCategory["Red Wine"]||0)}</div><div class="s">Subtotal</div></div>
        <div class="kpi"><div class="t">Sparkling Wine</div><div class="v">${fmtMoney(totals.byCategory["Sparkling Wine"]||0)}</div><div class="s">Subtotal</div></div>
      </div>
      <div class="divider"></div>
      <div class="tablewrap">
        <table style="min-width:560px;">
          <thead><tr><th>Category</th><th class="right">Value</th></tr></thead>
          <tbody>
            ${catRows.map(r=>`<tr><td><b>${escapeHtml(r.cat)}</b></td><td class="right mono">${fmtMoney(r.val)}</td></tr>`).join("")}
            <tr><td><b>Total</b></td><td class="right mono"><b>${fmtMoney(totals.grandTotal)}</b></td></tr>
          </tbody>
        </table>
      </div>
    `;
  }

  // CSV export (reports-style)
  $("#btnExportAll").onclick=()=>{
    const m = selectedMonth;
    const t = computeTotalsForMonth(m);
    const rows = [["month","category","value"]];
    Object.keys(t.byCategory).sort().forEach(cat => rows.push([m, cat, round2(t.byCategory[cat])]));
    rows.push([m, "TOTAL", t.grandTotal]);
    const csv = rows.map(r => r.map(c => {
      const s = String(c ?? "");
      return /[",\n]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s;
    }).join(",")).join("\n");
    const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = `fh_inventory_value_${m}.csv`;
    document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);
    toast("CSV downloaded");
  };

  // Tab wiring
  $$(".tab").forEach(t=>t.addEventListener("click",()=>{
    currentTab=t.dataset.tab;
    render();
  }));

  // Month wiring
  $("#monthSelect").addEventListener("change",(e)=>{
    selectedMonth=e.target.value;
    $("#pillMonth").textContent=selectedMonth;
    ensureMonthPriceSnapshot(selectedMonth);
    saveState(); cloudSaveState();
    render();
  });

  // ====== BOOT ======
  $("#appVersionBadge").textContent = APP_VERSION;
  buildMonthOptions();
  ensureMonthPriceSnapshot(selectedMonth);
  saveState();
  render();
  // cloud UI
  syncCloudUI();
  initSupabase().then(()=>{ syncCloudUI(); buildMonthOptions(); render(); }).catch((e)=>{ console.error(e); syncCloudUI(); });
})();
</script>
</body>
</html>
