<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>FH Liquor Inventory <span id="appVersionBadge" class="badge" style="margin-left:8px; font-size:12px;">vFINAL-2</span></title>
  <style>
    :root{
      --bg:#0b0f19; --panel:#121a2a; --panel2:#0f1626; --text:#e7ecff; --muted:#aab3d6;
      --border:rgba(255,255,255,.12); --accent:#6ea8ff; --good:#52d19a; --warn:#ffcc66; --bad:#ff6b6b;
      --shadow: 0 16px 40px rgba(0,0,0,.35);
      --radius:16px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:var(--sans); background:radial-gradient(1200px 700px at 10% 0%, rgba(110,168,255,.18), transparent 50%),
      radial-gradient(900px 600px at 90% 20%, rgba(82,209,154,.12), transparent 55%),
      var(--bg);
      color:var(--text);
    }
    .wrap{max-width:1200px; margin:28px auto; padding:0 18px 40px;}
    header{
      display:flex; gap:14px; align-items:flex-end; justify-content:space-between; margin-bottom:16px;
    }
    .title{display:flex; flex-direction:column; gap:6px;}
    h1{font-size:22px; margin:0; letter-spacing:.2px}
    .sub{color:var(--muted); font-size:13px}
    .pillbar{display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:flex-end}
    .pill{
      border:1px solid var(--border); background:rgba(255,255,255,.04);
      padding:8px 10px; border-radius:999px; font-size:12px; color:var(--muted);
      display:flex; gap:8px; align-items:center;
    }
    .pill b{color:var(--text); font-weight:600}
    .btn{
      appearance:none; border:1px solid var(--border); background:rgba(255,255,255,.06);
      color:var(--text); padding:10px 12px; border-radius:12px; cursor:pointer; font-weight:600;
      transition:transform .02s ease, background .15s ease, border-color .15s ease;
      display:inline-flex; gap:8px; align-items:center;
    }
    .btn:hover{background:rgba(255,255,255,.09); border-color:rgba(255,255,255,.18)}
    .btn:active{transform:translateY(1px)}
    .btn.primary{background:rgba(110,168,255,.18); border-color:rgba(110,168,255,.35)}
    .btn.primary:hover{background:rgba(110,168,255,.24)}
    .btn.danger{background:rgba(255,107,107,.12); border-color:rgba(255,107,107,.30)}
    .btn.ghost{background:transparent}
    .grid{display:grid; grid-template-columns: 280px 1fr; gap:14px;}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} }
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding:14px 14px 10px; border-bottom:1px solid var(--border);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      background:rgba(0,0,0,.14);
    }
    .card .hd h2{font-size:14px; margin:0; letter-spacing:.3px}
    .card .bd{padding:14px}
    .tabs{display:flex; gap:8px; flex-wrap:wrap}
    .tab{
      padding:10px 12px; border-radius:12px; border:1px solid var(--border);
      background:rgba(255,255,255,.04); color:var(--muted); cursor:pointer; font-weight:700; font-size:12px;
    }
    .tab.active{background:rgba(110,168,255,.18); border-color:rgba(110,168,255,.35); color:var(--text)}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    label{font-size:12px; color:var(--muted); display:block; margin-bottom:6px}
    .field{display:flex; flex-direction:column; gap:6px; min-width:180px}
    input, select{
      width:100%; padding:10px 11px; border-radius:12px; border:1px solid var(--border);
      background:rgba(0,0,0,.18); color:var(--text); outline:none;
    }
    input::placeholder{color:rgba(231,236,255,.35)}
    input:focus, select:focus{border-color:rgba(110,168,255,.55)}
    .hint{color:var(--muted); font-size:12px; line-height:1.35}
    .divider{height:1px; background:var(--border); margin:12px 0}
    .tablewrap{overflow:auto; border-radius:14px; border:1px solid var(--border)}
    table{
      width:100%; border-collapse:separate; border-spacing:0; min-width:880px;
      background:rgba(0,0,0,.18);
    }
    th, td{
      padding:10px 10px; border-bottom:1px solid rgba(255,255,255,.08); vertical-align:middle;
      font-size:13px;
    }
    th{
      position:sticky; top:0; background:rgba(18,26,42,.92); z-index:1;
      text-align:left; color:var(--muted); font-size:12px; letter-spacing:.25px;
    }
    tr:hover td{background:rgba(255,255,255,.03)}
    .right{text-align:right}
    .mono{font-family:var(--mono)}
    .badge{
      padding:4px 8px; border-radius:999px; border:1px solid var(--border);
      font-size:11px; color:var(--muted); background:rgba(255,255,255,.04); display:inline-flex; gap:6px; align-items:center;
    }
    .badge.good{border-color:rgba(82,209,154,.35); background:rgba(82,209,154,.12); color:#bff6dc}
    .badge.bad{border-color:rgba(255,107,107,.35); background:rgba(255,107,107,.12); color:#ffd0d0}
    .badge.warn{border-color:rgba(255,204,102,.35); background:rgba(255,204,102,.12); color:#ffe3b0}
    .kpis{display:grid; grid-template-columns:repeat(4, 1fr); gap:10px}
    @media (max-width: 980px){ .kpis{grid-template-columns:repeat(2, 1fr)} }
    .kpi{
      padding:12px; border-radius:14px; border:1px solid var(--border);
      background:rgba(255,255,255,.03);
    }
    .kpi .t{font-size:12px; color:var(--muted); margin-bottom:6px}
    .kpi .v{font-size:16px; font-weight:800}
    .kpi .s{font-size:12px; color:var(--muted); margin-top:2px}
    .actions{display:flex; gap:8px; flex-wrap:wrap; align-items:center; justify-content:flex-end}
    .toast{
      position:fixed; right:14px; bottom:14px; padding:12px 12px;
      border-radius:14px; border:1px solid var(--border);
      background:rgba(18,26,42,.92); box-shadow:var(--shadow);
      color:var(--text); display:none; max-width:340px;
    }
    .toast.show{display:block}
    .toast .msg{font-size:13px; line-height:1.35}
  
    /* Keep the right-most Actions column visible */
    .tablewrap{ overflow:auto; border-radius:14px; border:1px solid var(--border); }
    table{ width:100%; }
    th.sticky-r, td.sticky-r{
      position: sticky;
      right: 0;
      background: rgba(18,26,42,.96);
      box-shadow: -10px 0 14px rgba(0,0,0,.25);
      z-index: 2;
    }
    td.sticky-r{ background: rgba(0,0,0,.28); }

  
  .modal{ position:fixed; inset:0; background:rgba(0,0,0,.55); display:flex; align-items:center; justify-content:center; z-index:9999; padding:18px; }
  .modalCard{ width:min(560px, 96vw); background:rgba(20,22,26,.98); border:1px solid rgba(255,255,255,.12); border-radius:18px; padding:16px 16px 14px; box-shadow:0 18px 60px rgba(0,0,0,.55); }

</style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
<div class="wrap">
  <header>
    <div class="title">
      <h1>FH Liquor Inventory <span class="badge warn"></span></h1>
      <div class="sub">Live (GitHub Pages) • Optional Cloud Sync (Supabase).</div>
    </div>
    <div class="pillbar">
      <div class="pill">Month: <b id="pillMonth">—</b></div>
      <div class="pill">Items: <b id="pillItems">0</b></div>
      <button class="btn ghost" id="btnExportAll">Export CSV</button>
<span id="cloudStatus" class="pill" style="margin-left:8px;">Cloud: not signed in</span>
<button id="authBtn" class="btn" style="margin-left:8px;">Sign in</button>
      
    </div>
  </header>

  <div class="grid">
    <div class="card">
      <div class="hd"><h2>Navigation</h2></div>
      <div class="bd">
        <div class="tabs">
          <button class="tab active" data-tab="items">Items</button>
          <button class="tab" data-tab="counts">Counts</button>
          <button class="tab" data-tab="reports">Reports</button>
</div>

        <div class="divider"></div>

        <div class="field">
          <label for="monthSelect">Inventory Month</label>
          <select id="monthSelect"></select>
          <div class="hint">Pick the month you’re counting. Counts are stored per month.</div>
        </div>

        <div class="divider"></div>

        <div class="hint">
          <b>Workflow:</b><br>
          1) Keep your master list clean in <b>Items</b><br>
          2) Once/month, enter counts in <b>Counts</b><br>
          3) Send Accounting the <b>Grand Total Value</b> from <b>Reports</b>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="hd">
        <h2 id="mainTitle">Items</h2>
        <div class="actions" id="mainActions"></div>
      </div>
      <div class="bd" id="mainBody"></div>
    </div>
  </div>
</div>

<div class="toast" id="toast"><div class="msg" id="toastMsg"></div></div>

<script>
  const APP_VERSION = "FINAL-2";


  // ===== Month helpers =====
  function isValidMonth(s){
    return typeof s === "string" && /^\d{4}-\d{2}$/.test(s);
  }
  function yyyymmFromDate(d){
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, "0");
    return `${y}-${m}`;
  }
  function addMonths(yyyymm, delta){
    if(!isValidMonth(yyyymm)) return yyyymmFromDate(new Date());
    const [y, m] = yyyymm.split("-").map(Number);
    const d = new Date(y, m - 1, 1);
    d.setMonth(d.getMonth() + delta);
    return yyyymmFromDate(d);
  }
  // =========================


  // =============================
  // SUPABASE (CLOUD SYNC) SETTINGS
  // =============================
  // Paste your Supabase Project URL + anon key below (Supabase Dashboard → Project Settings → API)
  const SUPABASE_URL = "PASTE_SUPABASE_URL_HERE";
  const SUPABASE_ANON_KEY = "PASTE_SUPABASE_ANON_KEY_HERE";
  const CLOUD_ROW_ID = 1; // single shared row

  const hasSupabaseConfig = () => SUPABASE_URL.startsWith("http") && SUPABASE_ANON_KEY.length > 30;

  let sb = null;
  let cloudUser = null;
  let cloudMode = false;

  async function initSupabase(){
    const statusEl = document.getElementById("cloudStatus");
    const authBtn = document.getElementById("authBtn");
    if(!statusEl || !authBtn) return;

    if(!hasSupabaseConfig()){
      statusEl.style.display="none";
      authBtn.style.display="none";
      return;
    }

    sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    statusEl.style.display="inline-flex";
    authBtn.style.display="inline-flex";

    wireAuthModal();

    try{
      const { data } = await sb.auth.getSession();
      cloudUser = data?.session?.user || null;
      cloudMode = !!cloudUser;
      syncCloudUI();

      if(cloudMode){
        await cloudLoadIntoState();
        render(); initSupabase();
      }
    }catch(e){
      console.warn("Supabase session error", e);
      cloudMode = false;
      syncCloudUI();
    }

    sb.auth.onAuthStateChange(async (_event, session)=>{
      cloudUser = session?.user || null;
      cloudMode = !!cloudUser;
      syncCloudUI();
      if(cloudMode){
        await cloudLoadIntoState();
        render();
      }
    });
  }

  function syncCloudUI(){
    const statusEl = document.getElementById("cloudStatus");
    const authBtn = document.getElementById("authBtn");
    if(!statusEl || !authBtn) return;
    if(!hasSupabaseConfig()){
      statusEl.style.display="none";
      authBtn.style.display="none";
      return;
    }
    statusEl.style.display="inline-flex";
    authBtn.style.display="inline-flex";
    if(cloudMode){
      statusEl.classList.add("good");
      statusEl.textContent = "Cloud: Signed in";
      authBtn.textContent = "Sign out";
    }else{
      statusEl.classList.remove("good");
      statusEl.textContent = "Cloud: Not signed in";
      authBtn.textContent = "Sign in";
    }
  }

  async function cloudLoadIntoState(){
    if(!sb) return;
    try{
      const { data, error } = await sb
        .from("inventory_state")
        .select("state_json")
        .eq("id", CLOUD_ROW_ID)
        .single();
      if(error){
        console.warn("Cloud load error:", error);
        toast("Cloud load failed (using local)");
        return;
      }
      if(data && data.state_json && typeof data.state_json === "object"){
        state = data.state_json;
        // Ensure required structure
        if(!Array.isArray(state.items)) state.items = [];
        if(!state.counts || typeof state.counts !== "object") state.counts = {};
        if(!state.monthPrices || typeof state.monthPrices !== "object") state.monthPrices = {};
        if(!state.finalizedMonths || typeof state.finalizedMonths !== "object") state.finalizedMonths = {};
        if(!state.settings) state.settings = {monthsToShow:12, categories: DEFAULT_CATEGORIES.slice(), lastCategory:null};
      }
    }catch(e){
      console.warn("Cloud load exception:", e);
      toast("Cloud load failed (using local)");
    }
  }

  async function cloudSaveState(){
    if(!cloudMode || !sb) return;
    try{
      const payload = { id: CLOUD_ROW_ID, state_json: state, updated_by: cloudUser?.id || null };
      const { error } = await sb.from("inventory_state").upsert(payload, { onConflict:"id" });
      if(error){
        console.warn("Cloud save error:", error);
        toast("Cloud save failed (saved locally)");
      }
    }catch(e){
      console.warn("Cloud save exception:", e);
      toast("Cloud save failed (saved locally)");
    }
  }

  function wireAuthModal(){
    const authBtn = document.getElementById("authBtn");
    const modal = document.getElementById("authModal");
    const closeBtn = document.getElementById("authClose");
    const sendBtn = document.getElementById("authSend");
    const emailInp = document.getElementById("authEmail");
    const msg = document.getElementById("authMsg");
    if(!authBtn || !modal || !sendBtn || !emailInp) return;

    function openModal(){
      msg.textContent = "";
      modal.style.display = "flex";
      setTimeout(()=>emailInp.focus(), 50);
    }
    function closeModal(){ modal.style.display="none"; }

    closeBtn?.addEventListener("click", closeModal);
    modal.addEventListener("click", (e)=>{ if(e.target===modal) closeModal(); });

    authBtn.addEventListener("click", async ()=>{
      if(!hasSupabaseConfig()) return;
      if(cloudMode){
        await sb.auth.signOut();
        cloudMode = false;
        cloudUser = null;
        syncCloudUI();
        toast("Signed out");
      }else{
        openModal();
      }
    });

    sendBtn.addEventListener("click", async ()=>{
      const email = (emailInp.value||"").trim();
      if(!email){ msg.textContent="Enter an email address."; return; }
      msg.textContent = "Sending magic link…";
      const redirectTo = window.location.href.split("#")[0];
      const { error } = await sb.auth.signInWithOtp({ email, options:{ emailRedirectTo: redirectTo }});
      msg.textContent = error ? ("Error: " + error.message) : "Check your email for the sign-in link.";
    });
  }


(() => {
  const STORE_KEY = "fh_inv_live_v8_clean";
  // Categories are user-managed (stored in state.settings.categories)
  const DEFAULT_CATEGORIES = [
    "White Wine","Red Wine","Sparkling Wine",
    "Beer",
    "Vodka","Whiskey","Tequila","Gin","Rum","Cordials/Other"
  ];

  const $ = (sel, root=document) => root.querySelector(sel);
  const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
  const fmtMoney = (n) => Number(n||0).toLocaleString(undefined,{style:"currency",currency:"USD"});
  const fmtNum = (n) => Number(n||0).toLocaleString(undefined,{maximumFractionDigits:2});
  const toast = (msg) => { $("#toastMsg").textContent = msg; $("#toast").classList.add("show"); clearTimeout(toast._t);
    toast._t=setTimeout(()=>$("#toast").classList.remove("show"),2200); };
  const uuid = () => "i_" + Math.random().toString(16).slice(2) + Date.now().toString(16);
  const yyyymmFromDate = (d)=>`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}`;
  const prevMonth = (yyyymm)=>{ const [y,m]=yyyymm.split("-").map(Number); const dt=new Date(y,m-1,1); dt.setMonth(dt.getMonth()-1); return yyyymmFromDate(dt); };
  const escapeHtml = (s)=>String(s??"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;");
  const round2 = (n)=>Math.round((Number(n||0)+Number.EPSILON)*100)/100;
  
  const isSpiritType = (cat) => ["Vodka","Whiskey","Tequila","Gin","Rum","Cordials/Other"].includes(cat);

  const catOrderIndex = (cat)=>{
    const cats = (state?.settings?.categories || DEFAULT_CATEGORIES);
    const idx = cats.indexOf(cat);
    return idx === -1 ? 999 : idx;
  };

  function defaultState(){
    const now=new Date(); const thisMonth=yyyymmFromDate(now); const lastMonth=prevMonth(thisMonth);    const items=[
      {id:uuid(),name:"CAVIT PG",category:"White Wine",unit_cost:6.11,uom:"btl",active:true},
      {id:uuid(),name:"KIM CRAWFORD SB large",category:"White Wine",unit_cost:13.50,uom:"btl",active:true},
      {id:uuid(),name:"KIM CRAWFORD SB small",category:"White Wine",unit_cost:13.50,uom:"btl",active:true},
      {id:uuid(),name:"KOSHER CHARD",category:"White Wine",unit_cost:10.21,uom:"btl",active:true},
      {id:uuid(),name:"LOUIS JADOT CHARD",category:"White Wine",unit_cost:13.09,uom:"btl",active:true},
      {id:uuid(),name:"MINUTY ROSE",category:"White Wine",unit_cost:16.24,uom:"btl",active:true},
      {id:uuid(),name:"ROB MONDAVI PRIV CHARD",category:"White Wine",unit_cost:18.66,uom:"btl",active:true},
      {id:uuid(),name:"ROBERT MONDAVI CHARD",category:"White Wine",unit_cost:14.72,uom:"btl",active:true},
      {id:uuid(),name:"STAGS LEAP CHARD",category:"White Wine",unit_cost:19.79,uom:"btl",active:true},
      {id:uuid(),name:"SYCAMORE LANE  Chard",category:"White Wine",unit_cost:6.46,uom:"btl",active:true},
      {id:uuid(),name:"SYCAMORE LANE PINOT GRIGIO",category:"White Wine",unit_cost:8.66,uom:"btl",active:true},
      {id:uuid(),name:"KOSHER CAB",category:"Red Wine",unit_cost:10.21,uom:"btl",active:true},
      {id:uuid(),name:"STAGS LEAP CAB",category:"Red Wine",unit_cost:23.22,uom:"btl",active:true},
      {id:uuid(),name:"SYCAMORE LANE CAB",category:"Red Wine",unit_cost:5.54,uom:"btl",active:true},
      {id:uuid(),name:"SYCAMORE LANE Merlot",category:"Red Wine",unit_cost:11.00,uom:"btl",active:true},
      {id:uuid(),name:"Two Vines PINOT NOIR",category:"Red Wine",unit_cost:14.09,uom:"btl",active:true},
      {id:uuid(),name:"BARON KOSHER CHAMPAGNE",category:"Sparkling Wine",unit_cost:12.66,uom:"btl",active:true},
      {id:uuid(),name:"Louis Pommery",category:"Sparkling Wine",unit_cost:0.00,uom:"btl",active:true},
      {id:uuid(),name:"VEUVE CLIQUOT",category:"Sparkling Wine",unit_cost:27.00,uom:"btl",active:true},
      {id:uuid(),name:"Yulupa PROSECCO",category:"Sparkling Wine",unit_cost:13.66,uom:"btl",active:true},
      {id:uuid(),name:"Abita Light",category:"Beer",unit_cost:1.29,uom:"cs",active:true},
      {id:uuid(),name:"AMSTEL",category:"Beer",unit_cost:1.33,uom:"cs",active:true},
      {id:uuid(),name:"Angry Orchard",category:"Beer",unit_cost:1.29,uom:"cs",active:true},
      {id:uuid(),name:"BLUE MOON",category:"Beer",unit_cost:1.65,uom:"cs",active:true},
      {id:uuid(),name:"BROOKLYN",category:"Beer",unit_cost:1.35,uom:"cs",active:true},
      {id:uuid(),name:"DOG FISH",category:"Beer",unit_cost:1.54,uom:"cs",active:true},
      {id:uuid(),name:"HEINEKEN",category:"Beer",unit_cost:1.33,uom:"cs",active:true},
      {id:uuid(),name:"Lagunitas",category:"Beer",unit_cost:1.35,uom:"cs",active:true},
      {id:uuid(),name:"MODELLO Negra",category:"Beer",unit_cost:1.35,uom:"cs",active:true},
      {id:uuid(),name:"Nice Slice",category:"Beer",unit_cost:1.54,uom:"cs",active:true},
      {id:uuid(),name:"ROUGE",category:"Beer",unit_cost:1.35,uom:"cs",active:true},
      {id:uuid(),name:"STELLA",category:"Beer",unit_cost:1.29,uom:"cs",active:true},
      {id:uuid(),name:"ABSOLUT",category:"Vodka",unit_cost:0.00,uom:"btl",active:true},
      {id:uuid(),name:"GREYGOOSE",category:"Vodka",unit_cost:38.29,uom:"btl",active:true},
      {id:uuid(),name:"KETTLE ONE - Grapefruit & Rose",category:"Vodka",unit_cost:31.77,uom:"btl",active:true},
      {id:uuid(),name:"KING ST. VODKA",category:"Vodka",unit_cost:31.77,uom:"btl",active:true},
      {id:uuid(),name:"STOLI RAZBERRY",category:"Vodka",unit_cost:26.89,uom:"btl",active:true},
      {id:uuid(),name:"STOLI VANILLA",category:"Vodka",unit_cost:26.89,uom:"btl",active:true},
      {id:uuid(),name:"BUSHMILLS",category:"Whiskey",unit_cost:22.19,uom:"btl",active:true},
      {id:uuid(),name:"CANADIAN CLUB",category:"Whiskey",unit_cost:22.69,uom:"btl",active:true},
      {id:uuid(),name:"CHIVAS",category:"Whiskey",unit_cost:35.00,uom:"btl",active:true},
      {id:uuid(),name:"CROWN ROYAL",category:"Whiskey",unit_cost:37.36,uom:"btl",active:true},
      {id:uuid(),name:"DEWARS",category:"Whiskey",unit_cost:23.75,uom:"btl",active:true},
      {id:uuid(),name:"GLENFIDICH",category:"Whiskey",unit_cost:49.35,uom:"btl",active:true},
      {id:uuid(),name:"GLENLIVET",category:"Whiskey",unit_cost:49.35,uom:"btl",active:true},
      {id:uuid(),name:"JACK DANIELS",category:"Whiskey",unit_cost:30.00,uom:"btl",active:true},
      {id:uuid(),name:"JAMESON",category:"Whiskey",unit_cost:35.07,uom:"btl",active:true},
      {id:uuid(),name:"JOHNNY BLACK",category:"Whiskey",unit_cost:45.36,uom:"btl",active:true},
      {id:uuid(),name:"JOHNNY RED",category:"Whiskey",unit_cost:22.18,uom:"btl",active:true},
      {id:uuid(),name:"KNOB CREEK",category:"Whiskey",unit_cost:35.00,uom:"btl",active:true},
      {id:uuid(),name:"MAKERS",category:"Whiskey",unit_cost:33.98,uom:"btl",active:true},
      {id:uuid(),name:"MC CALLAN 12YRS",category:"Whiskey",unit_cost:45.87,uom:"btl",active:true},
      {id:uuid(),name:"SEAGRAMS",category:"Whiskey",unit_cost:18.98,uom:"btl",active:true},
      {id:uuid(),name:"MEZCAL JOVEN",category:"Tequila",unit_cost:35.00,uom:"btl",active:true},
      {id:uuid(),name:"PATRON SILVER",category:"Tequila",unit_cost:40.01,uom:"btl",active:true},
      {id:uuid(),name:"BEEFEATER",category:"Gin",unit_cost:23.39,uom:"btl",active:true},
      {id:uuid(),name:"BOMBAY SAPPHIRE",category:"Gin",unit_cost:29.99,uom:"btl",active:true},
      {id:uuid(),name:"GORDON",category:"Gin",unit_cost:31.99,uom:"btl",active:true},
      {id:uuid(),name:"TANQUERY",category:"Gin",unit_cost:29.68,uom:"btl",active:true},
      {id:uuid(),name:"BAC ARDI LIMON",category:"Rum",unit_cost:18.99,uom:"btl",active:true},
      {id:uuid(),name:"BACARDI",category:"Rum",unit_cost:19.39,uom:"btl",active:true},
      {id:uuid(),name:"CAPTAIN MORGAN",category:"Rum",unit_cost:19.39,uom:"btl",active:true},
      {id:uuid(),name:"GOSELINGS",category:"Rum",unit_cost:19.86,uom:"btl",active:true},
      {id:uuid(),name:"MALIBU",category:"Rum",unit_cost:24.00,uom:"btl",active:true},
      {id:uuid(),name:"MYERS",category:"Rum",unit_cost:30.07,uom:"btl",active:true},
      {id:uuid(),name:"AMARETTO DISARONO",category:"Cordials/Other",unit_cost:32.00,uom:"btl",active:true},
      {id:uuid(),name:"BALIEYS",category:"Cordials/Other",unit_cost:31.89,uom:"btl",active:true},
      {id:uuid(),name:"BLUE CURACO",category:"Cordials/Other",unit_cost:11.01,uom:"btl",active:true},
      {id:uuid(),name:"CACHACA",category:"Cordials/Other",unit_cost:21.11,uom:"btl",active:true},
      {id:uuid(),name:"CAMPARI",category:"Cordials/Other",unit_cost:29.00,uom:"btl",active:true},
      {id:uuid(),name:"CHAMBORD",category:"Cordials/Other",unit_cost:29.99,uom:"btl",active:true},
      {id:uuid(),name:"COINTREAU",category:"Cordials/Other",unit_cost:45.27,uom:"btl",active:true},
      {id:uuid(),name:"DRAMBIUE",category:"Cordials/Other",unit_cost:39.49,uom:"btl",active:true},
      {id:uuid(),name:"FRANGELICO",category:"Cordials/Other",unit_cost:26.49,uom:"btl",active:true},
      {id:uuid(),name:"GINGER BEER",category:"Cordials/Other",unit_cost:0.00,uom:"btl",active:true},
      {id:uuid(),name:"GODIVA WHITE CHOCOLATE",category:"Cordials/Other",unit_cost:19.90,uom:"btl",active:true},
      {id:uuid(),name:"GODVIVA  MILK CHOCOLATE & DARK",category:"Cordials/Other",unit_cost:20.59,uom:"btl",active:true},
      {id:uuid(),name:"GRAND MARNIER",category:"Cordials/Other",unit_cost:42.28,uom:"btl",active:true},
      {id:uuid(),name:"HENNESSY VSOP",category:"Cordials/Other",unit_cost:45.00,uom:"btl",active:true},
      {id:uuid(),name:"KAHLUA",category:"Cordials/Other",unit_cost:26.04,uom:"btl",active:true},
      {id:uuid(),name:"KEDEM DRY",category:"Cordials/Other",unit_cost:36.46,uom:"btl",active:true},
      {id:uuid(),name:"KEDEM SWEET",category:"Cordials/Other",unit_cost:36.46,uom:"btl",active:true},
      {id:uuid(),name:"MARTINI & ROSSI DRY / Foro DRY",category:"Cordials/Other",unit_cost:9.69,uom:"btl",active:true},
      {id:uuid(),name:"MARTINI & ROSSI SWEET",category:"Cordials/Other",unit_cost:9.69,uom:"btl",active:true},
      {id:uuid(),name:"PEACH SNAPS",category:"Cordials/Other",unit_cost:9.00,uom:"btl",active:true},
      {id:uuid(),name:"PEPPERMINT SCHNAPPS",category:"Cordials/Other",unit_cost:9.00,uom:"btl",active:true},
      {id:uuid(),name:"PERNOD",category:"Cordials/Other",unit_cost:32.11,uom:"btl",active:true},
      {id:uuid(),name:"REMY MARTIN VSOP",category:"Cordials/Other",unit_cost:60.50,uom:"btl",active:true},
      {id:uuid(),name:"ROMANO SAMBUCA",category:"Cordials/Other",unit_cost:27.69,uom:"btl",active:true},
      {id:uuid(),name:"RUMPLEMINTS",category:"Cordials/Other",unit_cost:26.49,uom:"btl",active:true},
      {id:uuid(),name:"SANDYMAN PORT",category:"Cordials/Other",unit_cost:26.00,uom:"btl",active:true},
      {id:uuid(),name:"SOUR APPLE",category:"Cordials/Other",unit_cost:9.00,uom:"btl",active:true},
      {id:uuid(),name:"SOUTHREN COMFORT",category:"Cordials/Other",unit_cost:24.06,uom:"btl",active:true},
      {id:uuid(),name:"TRIPLE SEC",category:"Cordials/Other",unit_cost:4.24,uom:"btl",active:true},
    ];

    const counts={}; counts[lastMonth]={}; counts[thisMonth]={};
    items.forEach((it,idx)=>{ counts[lastMonth][it.id]=idx%2===0?4:7; counts[thisMonth][it.id]=idx%2===0?5:6; });
    return {version:2,items,counts,monthPrices:{},settings:{monthsToShow:12, categories: DEFAULT_CATEGORIES.slice()}};
  }
  function loadState(){
    try{ const raw=localStorage.getItem(STORE_KEY); if(!raw) return defaultState();
      const s=JSON.parse(raw); if(!s||typeof s!=="object") return defaultState();
      if(s.version !== 2) return defaultState();
      if(!Array.isArray(s.items)) s.items=[]; if(!s.counts||typeof s.counts!=="object") s.counts={};
      if(!s.monthPrices || typeof s.monthPrices!=="object") s.monthPrices = {};
      // migrate older builds that used cost_overrides
      if(s.cost_overrides && typeof s.cost_overrides==="object"){
        Object.keys(s.cost_overrides).forEach(m=>{
          s.monthPrices[m] = Object.assign({}, s.cost_overrides[m]);
        });
        delete s.cost_overrides;
      }
      if(!s.settings) s.settings={monthsToShow:12, categories: DEFAULT_CATEGORIES.slice(), lastCategory: null};
      if(s.settings.lastCategory === undefined) s.settings.lastCategory = null;
      if(!Array.isArray(s.settings.categories) || s.settings.categories.length===0){
        s.settings.categories = DEFAULT_CATEGORIES.slice();
      }else{
        // merge in any new defaults without overwriting user's custom list
        DEFAULT_CATEGORIES.forEach(c => { if(!s.settings.categories.includes(c)) s.settings.categories.push(c); });
      }
      return s;
    }catch(e){ return defaultState(); }
  }
  let state=loadState();
  let currentTab="items";
  let selectedMonth=null;

  function saveState(){ localStorage.setItem(STORE_KEY, JSON.stringify(state)); $("#pillItems").textContent=String(state.items.filter(i=>i.active).length); }
  function mkBtn(text, cls="", onClick=()=>{}){ const b=document.createElement("button"); b.className="btn"+(cls?" "+cls:""); b.textContent=text; b.onclick=onClick; return b; }

  
  function buildMonthOptions(){
    const sel=$("#monthSelect");
    sel.innerHTML="";
    const now = new Date();
    const cur = yyyymmFromDate(now);

    // "Real months" = months that have saved data (counts or price snapshots)
    const real = new Set();
    if(state && state.counts){
      Object.keys(state.counts).forEach(k=>{ if(isValidMonth(k)) real.add(k); });
    }
    if(state && state.monthPrices){
      Object.keys(state.monthPrices).forEach(k=>{ if(isValidMonth(k)) real.add(k); });
    }

    // Always include current month + next 3 months so you can start ahead
    const futureMonths = [cur, addMonths(cur,1), addMonths(cur,2), addMonths(cur,3)];
    futureMonths.forEach(m=>real.add(m));

    // If selectedMonth exists but isn't in the set (edge case), include it
    if(selectedMonth && isValidMonth(selectedMonth)) real.add(selectedMonth);

    const months = Array.from(real).sort(); // ascending YYYY-MM
    months.forEach(m=>{
      const opt=document.createElement("option");
      opt.value=m;
      opt.textContent=m;
      sel.appendChild(opt);
    });

    // Default selection: keep selectedMonth if available, else current
    if(!selectedMonth || !real.has(selectedMonth)){
      selectedMonth = cur;
    }
    sel.value = selectedMonth;
    $("#pillMonth").textContent = selectedMonth;
  }

  function setTitle(t){ $("#mainTitle").textContent=t; }
  function setActions(nodes){ const host=$("#mainActions"); host.innerHTML=""; nodes.forEach(n=>host.appendChild(n)); }


  function ensureMonthPriceSnapshot(month){
    if(!month) return;
    if(!state.monthPrices) state.monthPrices = {};
    if(!state.monthPrices[month]){
      state.monthPrices[month] = {};
      // snapshot current prices for all items (active+inactive) so history stays consistent
      state.items.forEach(it=>{
        state.monthPrices[month][it.id] = Number(it.unit_cost||0);
      });
      saveState(); cloudSaveState();
    }
  }

  function getUnitCostForMonth(it, month){
    ensureMonthPriceSnapshot(month);
    const snap = state.monthPrices?.[month]?.[it.id];
    return (snap === undefined || snap === null) ? Number(it.unit_cost||0) : Number(snap||0);
  }

  function setUnitCostForMonthAndCurrent(it, month, value){
    const v = Number(value||0);
    // update current going-forward price
    it.unit_cost = v;
    // update this month's snapshot
    ensureMonthPriceSnapshot(month);
    setUnitCostForMonthAndCurrent(it, month, v);
    saveState(); cloudSaveState();
  }

function computeTotalsForMonth(month){
    const byCategory={}; let grandTotal=0;
    const items=state.items.filter(i=>i.active);
    const counts=(state.counts[month]||{});
    for(const it of items){
      const c=Number(counts[it.id]??0);
      const uc=getUnitCostForMonth(it, month);
      const v=c*uc;
      const cat=it.category||"Other";
      byCategory[cat]=(byCategory[cat]||0)+v;
      grandTotal+=v;
    }
    return {byCategory, grandTotal: round2(grandTotal)};
  }

  function render(){
    $("#pillMonth").textContent=selectedMonth||"—";
    $("#pillItems").textContent=String(state.items.filter(i=>i.active).length);
    $$(".tab").forEach(t=>t.classList.toggle("active", t.dataset.tab===currentTab));
    if(currentTab==="items") renderItems();
    if(currentTab==="counts") renderCounts();
    if(currentTab==="reports") renderReports();
    
  }

  function renderItems(){
    setTitle("Items");
    const addBtn=mkBtn("➕ Add Item","primary",()=>openItemEditor());
    const body=$("#mainBody");
    body.innerHTML=`
      <div class="row" style="justify-content:space-between; align-items:flex-end;">
        <div class="field" style="min-width:260px;">
          <label>Search</label>
          <input id="itemSearch" placeholder="Type to filter items…" />
        </div>
        <div class="field" style="min-width:220px;">
          <label>Show</label>
          <select id="itemFilter">
            <option value="active" selected>Active items</option>
            <option value="all">All items</option>
            <option value="inactive">Inactive only</option>
          </select>
        </div>
      </div>
      <div class="divider"></div>
      <div class="hint">If the Actions buttons are tight, scroll the table left/right — the Actions column stays pinned on the right.</div>
      <div class="divider"></div>
      <div class="tablewrap">
        <table>
          <thead>
            <tr>
              <th style="min-width:240px;">Item</th>
              <th style="min-width:120px;">Category</th>
              <th style="min-width:80px;">UOM</th>
              <th class="right" style="min-width:120px;">Unit Cost</th>
              <th style="min-width:160px;">Status</th>
              <th class="right sticky-r" style="min-width:180px;">Actions</th>
            </tr>
          </thead>
          <tbody id="itemsTbody"></tbody>
        </table>
      </div>
    `;

    const search=$("#itemSearch");
    const filter=$("#itemFilter");

    const rerenderRows=()=>{
      const q=(search.value||"").trim().toLowerCase();
      const f=filter.value;
      const rows=state.items.slice().sort((a,b)=>{ const d=catOrderIndex(a.category)-catOrderIndex(b.category); return d!==0?d:(a.name||"").localeCompare(b.name||""); })
        .filter(it=>{
          if(f==="active" && !it.active) return false;
          if(f==="inactive" && it.active) return false;
          if(!q) return true;
          return (it.name||"").toLowerCase().includes(q) || (it.category||"").toLowerCase().includes(q);
        });

      const tb=$("#itemsTbody"); tb.innerHTML="";
      rows.forEach(it=>tb.appendChild(itemRow(it)));
      if(rows.length===0) tb.innerHTML=`<tr><td colspan="6" style="color:rgba(255,255,255,.7);font-size:13px;">No matching items.</td></tr>`;
    };

    search.addEventListener("input", rerenderRows);
    filter.addEventListener("change", rerenderRows);
    rerenderRows();
  }

  function itemRow(it){
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td><b>${escapeHtml(it.name)}</b></td>
      <td>${escapeHtml(it.category||"")}</td>
      <td class="mono">${escapeHtml(it.uom||"")}</td>
      <td class="right mono">${fmtMoney(it.unit_cost)}</td>
      <td>${it.active?`<span class="badge good">Active</span>`:`<span class="badge bad">Inactive</span>`}</td>
      <td class="right sticky-r"></td>
    `;
    const td=tr.lastElementChild;
    const edit=mkBtn("Edit","",()=>openItemEditor(it));
    const toggle=mkBtn(it.active?"Deactivate":"Activate","",()=>{
      it.active=!it.active; saveState(); cloudSaveState(); render(); toast(it.active?"Item activated":"Item deactivated");
    });
    const del=mkBtn("Delete","danger",()=>{
      if(!confirm(`Delete "${it.name}"?\n\nThis removes it completely (including stored counts).`)) return;
      Object.keys(state.counts).forEach(m=>{ if(state.counts[m]) delete state.counts[m][it.id]; });
      state.items=state.items.filter(x=>x.id!==it.id);
      saveState(); cloudSaveState(); render(); toast("Item deleted");
    });
    const wrap=document.createElement("div");
    wrap.style.display="flex"; wrap.style.gap="8px"; wrap.style.justifyContent="flex-end"; wrap.style.flexWrap="wrap";
    wrap.append(edit,toggle,del);
    td.appendChild(wrap);
    return tr;
  }

  function openItemEditor(existing=null){
    const isEdit=!!existing;
    const it=existing?{...existing}:{id:uuid(),name:"",category:"Spirits",unit_cost:0,uom:"btl",active:true};
    const body=$("#mainBody");
    body.innerHTML=`
      <div class="row">
        <div class="field" style="min-width:320px; flex:1;">
          <label>Item Name</label>
          <input id="editName" placeholder="e.g., Tito's 1L" />
        </div>
        <div class="field" style="min-width:180px;">
          <label>Category</label>
          <select id="editCategory"></select>
<div class="hint" style="margin-top:6px;"><strong>Category controls where this item appears on the Counts screen.</strong><br/>(Reports still roll everything up to Wine, Beer, and Spirits.)</div>
        </div>
        <div class="field" style="min-width:120px;">
          <label>UOM</label>
          <input id="editUom" placeholder="btl/cs/keg" />
        </div>
        <div class="field" style="min-width:160px;">
          <label>Unit Cost</label>
          <input id="editCost" type="number" step="0.01" min="0" />
        </div>
        <div class="field" style="min-width:160px;">
          <label>Status</label>
          <select id="editActive">
            <option value="true">Active</option>
            <option value="false">Inactive</option>
          </select>
        </div>
      </div>
      <div class="divider"></div>
      <div class="actions">
        <button class="btn" id="cancelEdit">Cancel</button>
        <button class="btn primary" id="saveEdit">${isEdit?"Save Changes":"Add Item"}</button>
      </div>
    `;
    const catSel=$("#editCategory");
    // Build category dropdown from managed list + "Add new…"
    const cats = (state.settings.categories || []).slice().sort((a,b)=>a.localeCompare(b));
    cats.forEach(c=>{ const opt=document.createElement("option"); opt.value=c; opt.textContent=c; catSel.appendChild(opt); });
    const addOpt=document.createElement("option"); addOpt.value="__ADD__"; addOpt.textContent="➕ Add new category…"; catSel.appendChild(addOpt);
    $("#editName").value=it.name;
    $("#editCategory").value = it.category || (state.settings.lastCategory || (state.settings.categories||[])[0] || "Beer");

    $("#editCategory").onchange=()=>{
      if($("#editCategory").value==="__ADD__"){
        const name = prompt("New category name (e.g., White Wine, Vodka, Gin):");
        if(!name){ $("#editCategory").value = it.category || (state.settings.lastCategory || (state.settings.categories||[])[0] || "Beer"); return; }
        const clean = name.trim();
        if(!clean){ $("#editCategory").value = it.category || (state.settings.lastCategory || (state.settings.categories||[])[0] || "Beer"); return; }
        if(!state.settings.categories.includes(clean)) state.settings.categories.push(clean);
        saveState(); cloudSaveState();
        // rebuild dropdown
        openItemEditor(existing);
      }
    };
    $("#editUom").value=it.uom||"";
    $("#editCost").value=Number(it.unit_cost||0);
    $("#editActive").value=String(!!it.active);

    $("#cancelEdit").onclick=()=>renderItems();
    $("#saveEdit").onclick=()=>{
      const name=($("#editName").value||"").trim();
      if(!name){ toast("Item name is required"); return; }
      it.name=name;
      it.category=($("#editCategory").value==="__ADD__" ? (it.category||"Beer") : $("#editCategory").value);
      state.settings.lastCategory = it.category;
      it.uom=($("#editUom").value||"").trim();
      it.unit_cost=Number($("#editCost").value||0);
      it.active=$("#editActive").value==="true";

      if(isEdit){
        const idx=state.items.findIndex(x=>x.id===existing.id);
        state.items[idx]=it;
        toast("Item updated");
      }else{
        state.items.push(it);
      toast(`New item added to ${it.category || "Category"}`);
        toast("Item added");
      }
      saveState(); cloudSaveState();
      renderItems();
    };
  }

  
  function printBlankSheet(){
    const month = selectedMonth || "—";
    // Use same sorted active items as Counts view
    const items=state.items.filter(i=>i.active).slice().sort((a,b)=>{ const d=catOrderIndex(a.category)-catOrderIndex(b.category); return d!==0?d:(a.name||"").localeCompare(b.name||""); });

    // Group by category
    const groups = {};
    items.forEach(it=>{
      const cat = it.category || "Uncategorized";
      if(!groups[cat]) groups[cat]=[];
      groups[cat].push(it);
    });

    const cats = (state.settings.categories || DEFAULT_CATEGORIES).filter(c=>groups[c] && groups[c].length>0);
    // Build printable HTML
    const style = `
      <style>
        @page { size: letter; margin: 0.5in; }
        body{ font-family: Arial, Helvetica, sans-serif; color:#111; }
        .footer{ position: fixed; bottom: -0.15in; left: 0; right: 0; font-size:10px; color:#666; display:flex; justify-content:space-between; }
        .pageno:after{ content: counter(page); }
        h1{ font-size:16px; margin:0 0 6px; }
        .meta{ font-size:12px; margin:0 0 14px; }
        .cat{ margin-top:16px; page-break-inside: avoid; }
        .cat h2{ font-size:13px; margin:0 0 6px; padding:6px 8px; background:#f2f4f7; border:1px solid #d0d7de; }
        table{ width:100%; border-collapse:collapse; }
        th, td{ border:1px solid #d0d7de; padding:6px 8px; font-size:11px; }
        th{ background:#fafbfc; text-align:left; }
        .count{ width:110px; }
        .uom{ width:70px; }
        .notes{ width:180px; }
        .small{ color:#555; font-size:10px; }
      </style>
    `;

    const header = `
      <h1>Faculty House — Monthly Beverage Inventory Count Sheet</h1>
      <div class="meta">
        <b>Inventory Month:</b> ${month} &nbsp;&nbsp;|&nbsp;&nbsp;
        <b>Date Counted:</b> ____________ &nbsp;&nbsp;|&nbsp;&nbsp;
        <b>Counted By:</b> __________________________
        <div class="small" style="margin-top:6px;">Enter counts on this sheet, then enter them in the app in the same order (category → alphabetical).</div>
      </div>
    `;

    let body = header;

    cats.forEach(cat=>{
      const rows = groups[cat].slice().sort((a,b)=>(a.name||"").localeCompare(b.name||""));
      body += `<div class="cat"><h2>${escapeHtml(cat)}</h2>`;
      body += `<table><thead><tr>
        <th>Item</th><th class="uom">UOM</th><th class="count">Count</th><th class="notes">Notes</th>
      </tr></thead><tbody>`;
      rows.forEach(it=>{
        body += `<tr>
          <td>${escapeHtml(it.name||"")}</td>
          <td>${escapeHtml(it.uom||"")}</td>
          <td>__________</td>
          <td></td>
        </tr>`;
      });
      body += `</tbody></table></div>`;
    });

    const win = window.open("", "_blank");
    win.document.open();
    win.document.write(`<!doctype html><html><head><meta charset="utf-8">${style}<title>FH Liquor Inventory vCLOUD-14</title></head><body>${body}<div class="footer"><div>Faculty House</div><div class="pageno">Page </div></div>
<div id="authModal" class="modal" style="display:none;">
  <div class="modalCard">
    <div style="display:flex; justify-content:space-between; align-items:center; gap:12px;">
      <h3 style="margin:0;">Sign in (Cloud Sync)</h3>
      <button id="authClose" class="btn">✕</button>
    </div>
    <p class="hint" style="margin:8px 0 12px;">
      Enter your email and you’ll receive a magic link. Click it to sign in.
    </p>
    <div class="row" style="gap:10px; align-items:flex-end;">
      <div class="field" style="flex:1;">
        <label>Email</label>
        <input id="authEmail" placeholder="name@columbia.edu" />
      </div>
      <button id="authSend" class="btn primary">Send Link</button>
    </div>
    <div class="divider"></div>
    <p class="hint" id="authMsg" style="margin:0;"></p>
  </div>
</div>


<script>
/* CLOUD14_WIRING */
(function() {
  const SUPABASE_URL = "https://yvznkaitcorhfoutfkmk.supabase.co";
  const SUPABASE_KEY = "sb_publishable_sAebZGIDamLvoOHt-dPyFA_D7Z8iR30";
  const REDIRECT_TO = "https://scottbuonomo-hub.github.io/fh-inventory/";

  function showModal() {
    const m = document.getElementById("authModal");
    if (m) m.style.display = "flex";
    const e = document.getElementById("authEmail");
    if (e) setTimeout(()=>e.focus(), 50);
  }
  function hideModal() {
    const m = document.getElementById("authModal");
    if (m) m.style.display = "none";
  }

  async function ensureClient() {
    const cs = document.getElementById("cloudStatus");
    if (!window.supabase || typeof window.supabase.createClient !== "function") {
      if (cs) cs.textContent = "Cloud: library not loaded";
      return null;
    }
    if (!window.supabaseClient) {
      window.supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    }
    return window.supabaseClient;
  }

  async function refreshStatus() {
    const cs = document.getElementById("cloudStatus");
    const client = await ensureClient();
    if (!client) return;
    try {
      const { data } = await client.auth.getSession();
      const email = data?.session?.user?.email;
      if (cs) cs.textContent = email ? ("Cloud: " + email) : "Cloud: not signed in";
    } catch (e) {
      if (cs) cs.textContent = "Cloud: error";
      console.warn(e);
    }
  }

  async function sendLink() {
    const msg = document.getElementById("authMsg");
    const emailEl = document.getElementById("authEmail");
    const email = (emailEl?.value || "").trim();
    if (!email) { if (msg) msg.textContent = "Enter an email address."; return; }
    if (!email.toLowerCase().endsWith("@columbia.edu")) { if (msg) msg.textContent = "Use your @columbia.edu email."; return; }

    const client = await ensureClient();
    if (!client) { if (msg) msg.textContent = "Supabase library not loaded. Refresh and try again."; return; }

    if (msg) msg.textContent = "Sending link…";
    try {
      const { error } = await client.auth.signInWithOtp({
        email,
        options: { emailRedirectTo: REDIRECT_TO }
      });
      if (error) { if (msg) msg.textContent = "Error: " + error.message; return; }
      if (msg) msg.textContent = "Email sent. Click the link to finish signing in.";
    } catch (e) {
      if (msg) msg.textContent = "Error: " + (e?.message || String(e));
    }
  }

  function wire() {
    const btn = document.getElementById("authBtn");
    if (btn) btn.onclick = (e)=>{ e.preventDefault(); showModal(); };
    const closeBtn = document.getElementById("authCloseBtn");
    if (closeBtn) closeBtn.onclick = hideModal;
    const sendBtn = document.getElementById("authSendBtn");
    if (sendBtn) sendBtn.onclick = sendLink;
    const modal = document.getElementById("authModal");
    if (modal) modal.addEventListener("click", (e)=>{ if (e.target === modal) hideModal(); });
    const emailEl = document.getElementById("authEmail");
    if (emailEl) emailEl.addEventListener("keydown", (e)=>{ if (e.key === "Enter") sendLink(); });
  }

  document.addEventListener("DOMContentLoaded", function() {
    wire();
    refreshStatus();
    // refresh again after a short delay in case the lib loads slightly later
    setTimeout(refreshStatus, 800);
    setTimeout(refreshStatus, 1800);
  });
})();
</script>

</body></html>
